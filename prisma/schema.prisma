generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING_SETUP
  DEACTIVATED
}

enum EntityType {
  PRIVATE_LIMITED
  EXEMPTED_PRIVATE_LIMITED
  PUBLIC_LIMITED
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LIMITED_PARTNERSHIP
  LIMITED_LIABILITY_PARTNERSHIP
  FOREIGN_COMPANY
  VARIABLE_CAPITAL_COMPANY
  OTHER
}

enum CompanyStatus {
  LIVE
  STRUCK_OFF
  WINDING_UP
  DISSOLVED
  IN_LIQUIDATION
  IN_RECEIVERSHIP
  AMALGAMATED
  CONVERTED
  OTHER
}

enum OfficerRole {
  DIRECTOR
  MANAGING_DIRECTOR
  ALTERNATE_DIRECTOR
  SECRETARY
  CEO
  CFO
  AUDITOR
  LIQUIDATOR
  RECEIVER
  JUDICIAL_MANAGER
}

enum ContactType {
  INDIVIDUAL
  CORPORATE
}

enum IdentificationType {
  NRIC
  FIN
  PASSPORT
  UEN
  OTHER
}

enum AddressType {
  REGISTERED_OFFICE
  MAILING
  RESIDENTIAL
  BUSINESS
}

enum AuditAction {
  // CRUD Operations
  CREATE
  UPDATE
  DELETE
  RESTORE

  // Document Operations
  UPLOAD
  DOWNLOAD
  EXTRACT

  // Authentication Events
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  PASSWORD_CHANGE_REQUIRED
  PASSWORD_CHANGE_CLEARED

  // Access Control
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_CHANGED

  // Tenant Operations
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  USER_INVITED
  USER_REMOVED

  // User Company Assignment
  USER_COMPANY_ASSIGNED
  USER_COMPANY_UPDATED
  USER_COMPANY_REMOVED

  // Data Operations
  EXPORT
  IMPORT
  BULK_UPDATE

  // Connector Operations
  CONNECTOR_CREATED
  CONNECTOR_UPDATED
  CONNECTOR_DELETED
  CONNECTOR_TESTED
  CONNECTOR_ENABLED
  CONNECTOR_DISABLED

  // Document Generation Module
  DOCUMENT_TEMPLATE_CREATED
  DOCUMENT_TEMPLATE_UPDATED
  DOCUMENT_TEMPLATE_DELETED
  DOCUMENT_TEMPLATE_DUPLICATED
  DOCUMENT_GENERATED
  DOCUMENT_FINALIZED
  DOCUMENT_UNFINALIZED
  DOCUMENT_ARCHIVED
  DOCUMENT_CLONED
  SHARE_LINK_CREATED
  SHARE_LINK_REVOKED
  LETTERHEAD_UPDATED
  COMMENT_CREATED
  COMMENT_RESOLVED
  COMMENT_HIDDEN

  // Backup Operations
  BACKUP_CREATED
  BACKUP_COMPLETED
  BACKUP_FAILED
  BACKUP_DELETED
  BACKUP_RESTORE_STARTED
  BACKUP_RESTORE_COMPLETED
  BACKUP_RESTORE_FAILED
  BACKUP_SCHEDULE_UPDATED

  // Exchange Rate Operations
  EXCHANGE_RATE_SYNCED
  EXCHANGE_RATE_CREATED
  EXCHANGE_RATE_UPDATED
  EXCHANGE_RATE_DELETED

  // Chart of Accounts Operations
  CHART_OF_ACCOUNTS_CREATED
  CHART_OF_ACCOUNTS_UPDATED
  CHART_OF_ACCOUNTS_DELETED
  CHART_OF_ACCOUNTS_MAPPING_CREATED
  CHART_OF_ACCOUNTS_MAPPING_UPDATED
  CHART_OF_ACCOUNTS_MAPPING_DELETED
}

enum ChangeSource {
  MANUAL
  BIZFILE_UPLOAD
  API
  SYSTEM
}

// ============================================================================
// BACKUP SYSTEM
// ============================================================================

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  RESTORING
  RESTORED
  DELETED
}

enum BackupType {
  MANUAL
  SCHEDULED
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

enum ConnectorType {
  AI_PROVIDER
  STORAGE
}

enum ConnectorProvider {
  // AI Providers
  OPENAI
  ANTHROPIC
  GOOGLE
  // Storage Providers
  ONEDRIVE
  SHAREPOINT
}

// ============================================================================
// TENANT (Multi-Tenancy Core)
// ============================================================================

model Tenant {
  id                String       @id @default(uuid())
  name              String
  slug              String       @unique // URL-friendly identifier
  status            TenantStatus @default(PENDING_SETUP)

  // Contact Info
  contactEmail      String?
  contactPhone      String?

  // Settings & Limits
  settings          Json?        // Tenant-specific configuration
  maxUsers          Int          @default(50)
  maxCompanies      Int          @default(100)
  maxStorageMb      Int          @default(10240) // 10GB default

  // Branding (optional)
  logoUrl           String?
  primaryColor      String?      @default("#294d44")

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  deletedAt         DateTime?
  deletedReason     String?
  activatedAt       DateTime?
  suspendedAt       DateTime?
  suspendReason     String?

  // Relations
  users             User[]
  companies         Company[]
  contacts          Contact[]
  documents         Document[]
  auditLogs         AuditLog[]
  roles             Role[]
  connectors        Connector[]
  connectorAccess   TenantConnectorAccess[]
  connectorUsageLogs ConnectorUsageLog[]

  // Document Generation Module
  documentTemplates    DocumentTemplate[]
  generatedDocuments   GeneratedDocument[]
  letterhead           TenantLetterhead?
  templatePartials     TemplatePartial[]
  aiConversations      AiConversation[]

  // Backup & Restore
  backups              TenantBackup[]
  backupSchedule       BackupSchedule?

  // Exchange Rates
  exchangeRates        ExchangeRate[]

  // Chart of Accounts
  chartOfAccounts      ChartOfAccount[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
  @@map("tenants")
}

// ============================================================================
// RBAC (Role-Based Access Control)
// ============================================================================

model Role {
  id          String   @id @default(uuid())
  tenantId    String?  // Nullable for global roles (SUPER_ADMIN)
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  name        String
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted

  // System role type for special handling
  // "SUPER_ADMIN" - Global admin, bypasses all checks
  // "TENANT_ADMIN" - Tenant admin, full access within tenant
  // null - Regular custom role, permissions via RolePermission
  systemRoleType String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([systemRoleType])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // e.g., "company", "document", "user", "contact"
  action      String   // e.g., "create", "read", "update", "delete", "export"
  description String?

  // Relations
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Optional: scope to specific company (null = tenant-wide)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleId, companyId])
  @@index([userId])
  @@index([roleId])
  @@index([companyId])
  @@index([userId, roleId, companyId]) // Composite index for permission checks
  @@map("user_role_assignments")
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Password management
  mustChangePassword    Boolean   @default(false)
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?
  passwordChangedAt     DateTime?

  // Tenant relation (required for all non-SUPER_ADMIN users)
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])

  // Relations
  auditLogs     AuditLog[]
  uploadedDocuments Document[]
  roleAssignments UserRoleAssignment[]
  companyAssignments UserCompanyAssignment[]
  connectorUsageLogs ConnectorUsageLog[]

  // Document Generation Module
  createdTemplates      DocumentTemplate[]    @relation("TemplateCreator")
  createdDocuments      GeneratedDocument[]   @relation("DocumentCreator")
  finalizedDocuments    GeneratedDocument[]   @relation("DocumentFinalizer")
  createdShares         DocumentShare[]       @relation("ShareCreator")
  authoredComments      DocumentComment[]     @relation("CommentAuthor")
  resolvedComments      DocumentComment[]     @relation("CommentResolver")
  hiddenComments        DocumentComment[]     @relation("CommentHider")
  documentDrafts        DocumentDraft[]       @relation("DraftAuthor")
  createdPartials       TemplatePartial[]     @relation("PartialCreator")
  aiConversations       AiConversation[]      @relation("ConversationOwner")

  @@index([email])
  @@index([tenantId])
  @@index([passwordResetToken])
  @@map("users")
}

// User-Company many-to-many assignment for multi-company access
// Note: Permissions are controlled via UserRoleAssignment (company-scoped roles)
// This table only tracks WHICH companies a user can access
model UserCompanyAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Whether this is the user's primary company (for UI purposes)
  isPrimary Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_company_assignments")
}

// ============================================================================
// COMPANY MANAGEMENT
// ============================================================================

model Company {
  id                    String        @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id])

  uen                   String        // Unique within tenant (see compound constraint)
  name                  String
  formerName            String?       // Previous company name (if any)
  dateOfNameChange      DateTime?     // Date when name was changed
  entityType            EntityType    @default(PRIVATE_LIMITED)
  status                CompanyStatus @default(LIVE)
  statusDate            DateTime?     // Date when status became effective
  incorporationDate     DateTime?
  registrationDate      DateTime?

  // Registered Office Address Date
  dateOfAddress         DateTime?     // Date when registered address became effective

  // Business Activity
  primarySsicCode       String?
  primarySsicDescription String?
  secondarySsicCode     String?
  secondarySsicDescription String?

  // Financial Year
  financialYearEndDay   Int?
  financialYearEndMonth Int?
  fyeAsAtLastAr         DateTime?     // Financial year end as at last annual return
  homeCurrency          String?       @default("SGD")

  // Compliance Dates
  lastAgmDate           DateTime?
  lastArFiledDate       DateTime?
  nextAgmDueDate        DateTime?
  nextArDueDate         DateTime?
  accountsDueDate       DateTime?

  // Capital
  paidUpCapitalCurrency String?       @default("SGD")
  paidUpCapitalAmount   Decimal?      @db.Decimal(18, 2)
  issuedCapitalCurrency String?       @default("SGD")
  issuedCapitalAmount   Decimal?      @db.Decimal(18, 2)

  // Flags
  hasCharges            Boolean       @default(false)
  isGstRegistered       Boolean       @default(false)
  gstRegistrationNumber String?
  gstRegistrationDate   DateTime?

  // Audit & Soft Delete
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  deletedAt             DateTime?
  deletedReason         String?

  // Relations
  formerNames           CompanyFormerName[]
  addresses             CompanyAddress[]
  officers              CompanyOfficer[]
  shareholders          CompanyShareholder[]
  shareCapital          ShareCapital[]
  charges               CompanyCharge[]
  documents             Document[]
  auditLogs             AuditLog[]
  contacts              CompanyContact[]
  roleAssignments       UserRoleAssignment[]
  userAssignments       UserCompanyAssignment[]
  noteTabs              NoteTab[]

  // Document Generation Module
  generatedDocuments    GeneratedDocument[]

  // Document Tags
  documentTags          DocumentTag[]

  // Chart of Accounts
  chartOfAccounts       ChartOfAccount[]
  accountMappings       ChartOfAccountsMapping[]

  @@unique([tenantId, uen]) // UEN unique within tenant
  @@index([tenantId])
  @@index([uen])
  @@index([name])
  @@index([status])
  @@index([entityType])
  @@index([tenantId, deletedAt])
  @@index([deletedAt])
  // Performance indexes for stats and search
  @@index([createdAt])
  @@index([nextArDueDate])
  @@index([status, nextArDueDate]) // For overdue filings query
  @@index([tenantId, status])
  @@map("companies")
}

model CompanyFormerName {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  formerName      String
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())

  @@index([companyId])
  @@map("company_former_names")
}

model CompanyAddress {
  id              String      @id @default(uuid())
  companyId       String
  company         Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addressType     AddressType
  block           String?
  streetName      String
  level           String?
  unit            String?
  buildingName    String?
  postalCode      String
  country         String      @default("SINGAPORE")
  fullAddress     String
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  isCurrent       Boolean     @default(true)
  sourceDocumentId String?
  document        Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([companyId])
  @@index([addressType])
  @@index([isCurrent])
  @@index([companyId, isCurrent]) // For search queries
  @@index([companyId, isCurrent, addressType])
  @@map("company_addresses")
}

// ============================================================================
// CONTACTS
// ============================================================================

model Contact {
  id                  String             @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId            String
  tenant              Tenant             @relation(fields: [tenantId], references: [id])

  contactType         ContactType        @default(INDIVIDUAL)

  // For Individuals
  firstName           String?
  lastName            String?
  fullName            String
  identificationType  IdentificationType?
  identificationNumber String?
  nationality         String?
  dateOfBirth         DateTime?

  // For Corporate
  corporateName       String?
  corporateUen        String?

  // Contact Info
  email               String?
  phone               String?

  // Address
  fullAddress         String?

  // Meta
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?

  // Relations
  companyRelations    CompanyContact[]
  officerPositions    CompanyOfficer[]
  shareholdings       CompanyShareholder[]
  chargeHoldings      CompanyCharge[]
  noteTabs            NoteTab[]

  @@unique([tenantId, identificationType, identificationNumber])
  @@index([tenantId])
  @@index([fullName])
  @@index([identificationNumber])
  @@index([corporateUen])
  @@index([tenantId, deletedAt])
  @@map("contacts")
}

model CompanyContact {
  id          String    @id @default(uuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  relationship String   // E.g., "Director", "Shareholder", "Auditor"
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // For soft delete support

  @@unique([companyId, contactId, relationship])
  @@index([companyId])
  @@index([contactId])
  @@index([deletedAt])
  @@map("company_contacts")
}

// ============================================================================
// OFFICERS
// ============================================================================

model CompanyOfficer {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  role              OfficerRole

  // Officer Details (denormalized for historical record)
  name              String
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  address           String?

  // Appointment
  appointmentDate   DateTime?
  cessationDate     DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([role])
  @@index([isCurrent])
  @@index([companyId, isCurrent]) // For search queries
  @@index([contactId, companyId]) // For contact lookup
  @@index([name, isCurrent]) // For name search
  @@map("company_officers")
}

// ============================================================================
// SHAREHOLDERS & CAPITAL
// ============================================================================

model ShareCapital {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  shareClass      String   @default("ORDINARY")
  currency        String   @default("SGD")
  numberOfShares  Int
  parValue        Decimal? @db.Decimal(18, 4)
  totalValue      Decimal  @db.Decimal(18, 2)
  isPaidUp        Boolean  @default(true)
  isTreasury      Boolean  @default(false)  // True for treasury shares

  effectiveDate   DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@map("share_capital")
}

model CompanyShareholder {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Shareholder Details (denormalized for historical record)
  name              String
  shareholderType   ContactType @default(INDIVIDUAL)
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  placeOfOrigin     String?     // For corporate shareholders
  address           String?

  // Shareholding
  shareClass        String      @default("ORDINARY")
  numberOfShares    Int
  percentageHeld    Decimal?    @db.Decimal(5, 2)
  currency          String      @default("SGD")

  // Dates
  allotmentDate     DateTime?
  transferDate      DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([isCurrent])
  @@index([companyId, isCurrent]) // For search queries
  @@index([contactId, companyId]) // For contact lookup
  @@index([name, isCurrent]) // For name search
  @@map("company_shareholders")
}

// ============================================================================
// CHARGES
// ============================================================================

model CompanyCharge {
  id                String    @id @default(uuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  chargeHolderId    String?
  chargeHolder      Contact?  @relation(fields: [chargeHolderId], references: [id])

  chargeNumber      String?
  chargeType        String?
  description       String?
  chargeHolderName  String
  amountSecured     Decimal?  @db.Decimal(18, 2)
  amountSecuredText String?   // For text values like "All Monies"
  currency          String?   @default("SGD")

  registrationDate  DateTime?
  dischargeDate     DateTime?
  isFullyDischarged Boolean   @default(false)

  sourceDocumentId  String?
  document          Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([chargeHolderId])
  @@index([isFullyDischarged])
  @@map("company_charges")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model Document {
  id              String    @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  // Company is optional for pending documents (e.g., BizFile upload before extraction)
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User      @relation(fields: [uploadedById], references: [id])

  documentType    String    // "BIZFILE", "CONSTITUTION", "RESOLUTION", etc.
  fileName        String
  originalFileName String
  storageKey      String    @map("storage_key")  // Storage key for file in object storage
  fileSize        Int
  mimeType        String

  // Extraction
  extractedAt     DateTime?
  extractionStatus String?   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  extractionError String?
  extractedData   Json?     // Raw extracted JSON data

  // Versioning
  version         Int       @default(1)
  isLatest        Boolean   @default(true)
  previousVersionId String?

  // Soft delete
  deletedAt       DateTime? @map("deleted_at")
  deletedReason   String?   @map("deleted_reason")
  deletedById     String?   @map("deleted_by_id")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations - data extracted from this document
  formerNames     CompanyFormerName[]
  addresses       CompanyAddress[]
  officers        CompanyOfficer[]
  shareCapital    ShareCapital[]
  shareholders    CompanyShareholder[]
  charges         CompanyCharge[]
  processingDocument ProcessingDocument?

  @@index([tenantId])
  @@index([companyId])
  @@index([documentType])
  @@index([uploadedById])
  @@index([tenantId, companyId])
  @@index([tenantId, deletedAt])
  @@map("documents")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id            String       @id @default(uuid())

  // Tenant (multi-tenancy) - optional for system-level events
  tenantId      String?
  tenant        Tenant?      @relation(fields: [tenantId], references: [id])

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])
  companyId     String?
  company       Company?     @relation(fields: [companyId], references: [id])

  action        AuditAction
  entityType    String       // "Tenant", "Company", "Contact", "Officer", etc.
  entityId      String

  changeSource  ChangeSource @default(MANUAL)
  changes       Json?        // { field: { old: value, new: value } }
  reason        String?      // Required for deletions
  summary       String?      // Human-readable description of the action
  entityName    String?      // Name of the affected entity (e.g., company name, user name)
  metadata      Json?        // Additional context

  // Request context
  ipAddress     String?
  userAgent     String?
  requestId     String?      // For correlating related operations
  sessionId     String?      // For tracking user sessions

  // Timestamps
  createdAt     DateTime     @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType])
  @@index([requestId])
  @@map("audit_logs")
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

model Connector {
  id                String            @id @default(uuid())

  // Tenant scope: null = system connector, otherwise tenant-specific
  tenantId          String?
  tenant            Tenant?           @relation(fields: [tenantId], references: [id])

  // Connector identification
  name              String            // Display name (e.g., "Production OpenAI")
  type              ConnectorType     // AI_PROVIDER, STORAGE
  provider          ConnectorProvider // OPENAI, ANTHROPIC, GOOGLE, ONEDRIVE

  // Configuration
  credentials       String            // Encrypted JSON: { apiKey, clientId, etc. }
  settings          Json?             // Provider-specific settings (model preferences, etc.)

  // Status
  isEnabled         Boolean           @default(true)
  isDefault         Boolean           @default(false) // Default for this type within scope

  // Usage tracking
  callCount         Int               @default(0)
  lastUsedAt        DateTime?
  lastTestedAt      DateTime?
  lastTestResult    String?           // "success" | "error:message"

  // Soft delete & timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  // Relations
  tenantAccess      TenantConnectorAccess[]
  usageLogs         ConnectorUsageLog[]

  @@unique([tenantId, provider, deletedAt])
  @@index([tenantId])
  @@index([type])
  @@index([provider])
  @@index([isEnabled])
  @@index([deletedAt])
  @@map("connectors")
}

// Per-tenant access control for system connectors
model TenantConnectorAccess {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  isEnabled     Boolean   @default(true)  // false = blocked for this tenant

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, connectorId])
  @@index([tenantId])
  @@index([connectorId])
  @@map("tenant_connector_access")
}

// Detailed usage logging for connectors
model ConnectorUsageLog {
  id            String    @id @default(uuid())

  // References
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  tenantId      String?   // Tenant that made the call (for billing attribution)
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userId        String?   // User who triggered the call
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // AI Model details
  model         String    // Model ID used (e.g., "gpt-4.1", "claude-sonnet-4.5")
  provider      String    // Provider name (openai, anthropic, google)

  // Token usage
  inputTokens   Int       @default(0)
  outputTokens  Int       @default(0)
  totalTokens   Int       @default(0)

  // Cost calculation (in USD cents for precision)
  costCents     Int       @default(0) // Total cost in cents (e.g., 150 = $1.50)

  // Performance
  latencyMs     Int?      // Response time in milliseconds

  // Request details
  operation     String?   // e.g., "bizfile_extraction", "document_analysis"
  success       Boolean   @default(true)
  errorMessage  String?   // Error details if failed

  // Metadata
  metadata      Json?     // Additional context (document ID, company ID, etc.)

  createdAt     DateTime  @default(now())

  @@index([connectorId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@index([connectorId, createdAt])
  @@index([tenantId, createdAt])
  @@map("connector_usage_logs")
}

// ============================================================================
// INTERNAL NOTES (Multi-Tab Rich Text Notes)
// ============================================================================

model NoteTab {
  id        String   @id @default(uuid())
  title     String   @default("General")
  content   String?  @db.Text  // Rich text HTML content
  order     Int      @default(0)

  // Relations (one of these will be set)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([order])
  @@map("note_tabs")
}

// ============================================================================
// DOCUMENT GENERATION MODULE
// ============================================================================

enum DocumentTemplateCategory {
  RESOLUTION
  CONTRACT
  LETTER
  MINUTES
  NOTICE
  CERTIFICATE
  OTHER
}

enum GeneratedDocumentStatus {
  DRAFT
  FINALIZED
  ARCHIVED
}

enum DocumentCommentStatus {
  OPEN
  RESOLVED
}

// Document Templates - Reusable templates with placeholders
model DocumentTemplate {
  id                    String                   @id @default(uuid())
  tenantId              String                   @map("tenant_id")
  tenant                Tenant                   @relation(fields: [tenantId], references: [id])

  name                  String                   @db.VarChar(200)
  description           String?                  @db.Text
  category              DocumentTemplateCategory @default(OTHER)
  content               String                   @db.Text // HTML content with placeholders
  contentJson           Json?                    @map("content_json") // TipTap JSON format
  placeholders          Json                     @default("[]") // Array of placeholder definitions
  isActive              Boolean                  @default(true) @map("is_active")
  defaultShareExpiryHours Int?                   @map("default_share_expiry_hours")
  version               Int                      @default(1)

  // Audit
  createdById           String                   @map("created_by_id")
  createdBy             User                     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")
  deletedAt             DateTime?                @map("deleted_at")

  // Relations
  generatedDocuments    GeneratedDocument[]

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
  @@index([tenantId, deletedAt])
  @@map("document_templates")
}

// Generated Documents - Documents created from templates
model GeneratedDocument {
  id                    String                   @id @default(uuid())
  tenantId              String                   @map("tenant_id")
  tenant                Tenant                   @relation(fields: [tenantId], references: [id])

  // Source template (nullable for documents without template)
  templateId            String?                  @map("template_id")
  template              DocumentTemplate?        @relation(fields: [templateId], references: [id])
  templateVersion       Int?                     @map("template_version") // Snapshot of template version used

  // Associated company (optional)
  companyId             String?                  @map("company_id")
  company               Company?                 @relation(fields: [companyId], references: [id])

  // Document content
  title                 String                   @db.VarChar(300)
  content               String                   @db.Text // Resolved HTML content
  contentJson           Json?                    @map("content_json") // TipTap JSON format
  status                GeneratedDocumentStatus  @default(DRAFT)

  // Finalization tracking
  finalizedAt           DateTime?                @map("finalized_at")
  finalizedById         String?                  @map("finalized_by_id")
  finalizedBy           User?                    @relation("DocumentFinalizer", fields: [finalizedById], references: [id])
  unfinalizedAt         DateTime?                @map("unfinalized_at") // Last time un-finalized

  // PDF options
  useLetterhead         Boolean                  @default(true) @map("use_letterhead")
  shareExpiryHours      Int?                     @map("share_expiry_hours") // Override template default

  // Metadata
  placeholderData       Json?                    @map("placeholder_data") // Snapshot of data used
  metadata              Json?                    // Additional metadata

  // Audit
  createdById           String                   @map("created_by_id")
  createdBy             User                     @relation("DocumentCreator", fields: [createdById], references: [id])
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")
  deletedAt             DateTime?                @map("deleted_at")

  // Relations
  sections              DocumentSection[]
  shares                DocumentShare[]
  comments              DocumentComment[]
  drafts                DocumentDraft[]

  @@index([tenantId])
  @@index([templateId])
  @@index([companyId])
  @@index([status])
  @@index([createdById])
  @@index([tenantId, deletedAt])
  @@map("generated_documents")
}

// Document Sections - For navigation sidebar
model DocumentSection {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  title                 String            @db.VarChar(200)
  anchor                String            @db.VarChar(100) // HTML anchor ID
  order                 Int
  level                 Int               @default(1) // Heading level (1, 2, 3)
  pageBreakBefore       Boolean           @default(false) @map("page_break_before")

  createdAt             DateTime          @default(now()) @map("created_at")

  @@index([documentId])
  @@index([documentId, order])
  @@map("document_sections")
}

// Document Shares - Shareable links with access control
model DocumentShare {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  shareToken            String            @unique @map("share_token") @db.VarChar(64)
  expiresAt             DateTime?         @map("expires_at")
  passwordHash          String?           @map("password_hash") @db.VarChar(255)
  isActive              Boolean           @default(true) @map("is_active")

  // Access tracking
  viewCount             Int               @default(0) @map("view_count")
  lastViewedAt          DateTime?         @map("last_viewed_at")

  // Permissions
  allowedActions        String[]          @default(["view"]) @map("allowed_actions") // view, download, print
  allowComments         Boolean           @default(false) @map("allow_comments")
  commentRateLimit      Int               @default(20) @map("comment_rate_limit") // Max comments/hour/IP
  notifyOnComment       Boolean           @default(false) @map("notify_on_comment")
  notifyOnView          Boolean           @default(false) @map("notify_on_view")

  // Audit
  createdById           String            @map("created_by_id")
  createdBy             User              @relation("ShareCreator", fields: [createdById], references: [id])
  createdAt             DateTime          @default(now()) @map("created_at")
  revokedAt             DateTime?         @map("revoked_at")

  // Relations
  comments              DocumentComment[]

  @@index([documentId])
  @@index([expiresAt])
  @@index([shareToken])
  @@index([shareToken, isActive]) // Composite index for share validation
  @@map("document_shares")
}

// Tenant Letterheads - PDF letterhead configuration
model TenantLetterhead {
  id                    String   @id @default(uuid())
  tenantId              String   @unique @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id])

  headerHtml            String?  @map("header_html") @db.Text
  footerHtml            String?  @map("footer_html") @db.Text
  headerImageUrl        String?  @map("header_image_url") @db.VarChar(500)
  footerImageUrl        String?  @map("footer_image_url") @db.VarChar(500)
  logoUrl               String?  @map("logo_url") @db.VarChar(500)
  pageMargins           Json     @default("{\"top\": 25, \"right\": 20, \"bottom\": 25, \"left\": 20}") @map("page_margins")
  isEnabled             Boolean  @default(true) @map("is_enabled")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("tenant_letterheads")
}

// Document Comments - Internal & external comments with text selection
model DocumentComment {
  id                    String               @id @default(uuid())
  documentId            String               @map("document_id")
  document              GeneratedDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // For external comments via share link
  shareId               String?              @map("share_id")
  share                 DocumentShare?       @relation(fields: [shareId], references: [id])

  // Internal user (null for external commenters)
  userId                String?              @map("user_id")
  user                  User?                @relation("CommentAuthor", fields: [userId], references: [id])

  // External commenter info
  guestName             String?              @map("guest_name") @db.VarChar(100)
  guestEmail            String?              @map("guest_email") @db.VarChar(255)

  // Comment content (max 1000 chars)
  content               String               @db.VarChar(1000)

  // Text selection (for linked comments)
  selectionStart        Int?                 @map("selection_start")
  selectionEnd          Int?                 @map("selection_end")
  selectedText          String?              @map("selected_text") @db.Text

  // Threading
  parentId              String?              @map("parent_id")
  parent                DocumentComment?     @relation("CommentReplies", fields: [parentId], references: [id])
  replies               DocumentComment[]    @relation("CommentReplies")

  // Status
  status                DocumentCommentStatus @default(OPEN)
  resolvedById          String?              @map("resolved_by_id")
  resolvedBy            User?                @relation("CommentResolver", fields: [resolvedById], references: [id])
  resolvedAt            DateTime?            @map("resolved_at")

  // Moderation
  hiddenAt              DateTime?            @map("hidden_at")
  hiddenById            String?              @map("hidden_by_id")
  hiddenBy              User?                @relation("CommentHider", fields: [hiddenById], references: [id])
  hiddenReason          String?              @map("hidden_reason") @db.VarChar(255)

  // Rate limiting
  ipAddress             String?              @map("ip_address") @db.VarChar(45)

  // Timestamps
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  deletedAt             DateTime?            @map("deleted_at")

  @@index([documentId])
  @@index([shareId])
  @@index([userId])
  @@index([parentId])
  @@index([status])
  @@index([ipAddress, createdAt])
  @@map("document_comments")
}

// Document Drafts - Auto-save storage
model DocumentDraft {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId                String            @map("user_id")
  user                  User              @relation("DraftAuthor", fields: [userId], references: [id])

  content               String            @db.Text
  contentJson           Json?             @map("content_json")
  metadata              Json?

  createdAt             DateTime          @default(now()) @map("created_at")

  @@index([documentId])
  @@index([userId, createdAt])
  @@map("document_drafts")
}

// Template Partials - Reusable template blocks (Phase 7)
model TemplatePartial {
  id                    String    @id @default(uuid())
  tenantId              String    @map("tenant_id")
  tenant                Tenant    @relation(fields: [tenantId], references: [id])

  name                  String    @db.VarChar(100)  // Identifier used in {{>name}} syntax
  displayName           String?   @map("display_name") @db.VarChar(200)  // Human-readable name shown in UI
  description           String?   @db.Text
  content               String    @db.Text
  placeholders          Json      @default("[]")

  createdById           String    @map("created_by_id")
  createdBy             User      @relation("PartialCreator", fields: [createdById], references: [id])
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("template_partials")
}

// AI Conversations - Chat history for AI assistant
model AiConversation {
  id                    String   @id @default(uuid())
  tenantId              String   @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id])
  userId                String   @map("user_id")
  user                  User     @relation("ConversationOwner", fields: [userId], references: [id])

  contextType           String   @db.VarChar(20) // 'template' or 'document'
  contextId             String?  @map("context_id") // Template or Document ID
  messages              Json     @default("[]") // Array of {role, content, timestamp}

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([tenantId, userId])
  @@index([contextType, contextId])
  @@map("ai_conversations")
}

// ============================================================================
// DOCUMENT PROCESSING MODULE - PHASE 1A
// Ingestion, Splitting, Classification & Extraction
// ============================================================================

// Document Pipeline Status
enum PipelineStatus {
  UPLOADED
  QUEUED
  PROCESSING
  SPLIT_PENDING
  SPLIT_DONE
  EXTRACTION_DONE
  FAILED_RETRYABLE
  FAILED_PERMANENT
  DEAD_LETTER
}

// Processing Priority
enum ProcessingPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

// Upload Source
enum UploadSource {
  WEB
  EMAIL
  API
  CLIENT_PORTAL
}

// Duplicate Status
enum DuplicateStatus {
  NONE
  SUSPECTED
  CONFIRMED
  REJECTED
}

// Extraction Type
enum ExtractionType {
  SPLIT
  FIELDS
}

// Revision Type
enum RevisionType {
  EXTRACTION
  USER_EDIT
  REPROCESS
  SYSTEM_MERGE
}

// Revision Status
enum RevisionStatus {
  DRAFT
  APPROVED
  SUPERSEDED
}

// Document Category (ordered by expected volume: high â†’ low)
enum DocumentCategory {
  ACCOUNTS_PAYABLE      // Vendor/Purchase documents
  ACCOUNTS_RECEIVABLE   // Customer/Sales documents
  TREASURY              // Banking & Cash management
  TAX_COMPLIANCE        // Tax & Regulatory
  PAYROLL               // HR & Payroll
  CORPORATE_SECRETARIAL // Corporate governance
  CONTRACTS             // Legal agreements
  FINANCIAL_REPORTS     // Reporting & Analysis
  INSURANCE             // Risk management
  CORRESPONDENCE        // General communications
  OTHER                 // Uncategorized
}

// Document Sub-Category
// Maps to parent categories as follows:
// ACCOUNTS_PAYABLE: VENDOR_INVOICE, VENDOR_CREDIT_NOTE, PURCHASE_ORDER, DELIVERY_NOTE, VENDOR_STATEMENT, VENDOR_QUOTATION
// ACCOUNTS_RECEIVABLE: SALES_INVOICE, SALES_CREDIT_NOTE, SALES_ORDER, DELIVERY_ORDER, CUSTOMER_STATEMENT
// TREASURY: BANK_STATEMENT, BANK_ADVICE, PAYMENT_VOUCHER, RECEIPT_VOUCHER, LOAN_DOCUMENT
// TAX_COMPLIANCE: GST_RETURN, INCOME_TAX, WITHHOLDING_TAX, TAX_INVOICE
// PAYROLL: PAYSLIP, CPF_SUBMISSION, IR8A, EXPENSE_CLAIM
// CORPORATE_SECRETARIAL: BIZFILE, RESOLUTION, REGISTER, INCORPORATION, ANNUAL_RETURN, MEETING_MINUTES
// CONTRACTS: VENDOR_CONTRACT, CUSTOMER_CONTRACT, EMPLOYMENT_CONTRACT, LEASE_AGREEMENT
// FINANCIAL_REPORTS: FINANCIAL_STATEMENT, MANAGEMENT_REPORT, AUDIT_REPORT
// INSURANCE: INSURANCE_POLICY, INSURANCE_CLAIM
// CORRESPONDENCE: LETTER, EMAIL
// OTHER: MISCELLANEOUS, SUPPORTING_DOCUMENT
enum DocumentSubCategory {
  // ACCOUNTS_PAYABLE
  VENDOR_INVOICE        // Purchase invoices & debit notes from suppliers
  VENDOR_CREDIT_NOTE    // Credit notes from suppliers
  PURCHASE_ORDER        // Purchase orders issued
  DELIVERY_NOTE         // Goods received notes, delivery receipts
  VENDOR_STATEMENT      // Supplier statements of account
  VENDOR_QUOTATION      // Quotations from suppliers

  // ACCOUNTS_RECEIVABLE
  SALES_INVOICE         // Invoices & debit notes to customers
  SALES_CREDIT_NOTE     // Credit notes to customers
  SALES_ORDER           // Sales orders & quotations
  DELIVERY_ORDER        // Delivery orders issued
  CUSTOMER_STATEMENT    // Customer statements of account

  // TREASURY
  BANK_STATEMENT        // Monthly/periodic bank statements
  BANK_ADVICE           // Debit/credit advices, TT advices, FD advices
  PAYMENT_VOUCHER       // Payment vouchers, cheques
  RECEIPT_VOUCHER       // Receipt vouchers
  LOAN_DOCUMENT         // Loan agreements, facility letters

  // TAX_COMPLIANCE
  GST_RETURN            // GST F5/F7 returns & assessments
  INCOME_TAX            // Form C/C-S, tax assessments, computations
  WITHHOLDING_TAX       // WHT certificates (Form IR37)
  TAX_INVOICE           // Tax invoices & receipts

  // PAYROLL
  PAYSLIP               // Employee payslips
  CPF_SUBMISSION        // CPF contribution records
  IR8A                  // Annual IR8A/IR8S forms
  EXPENSE_CLAIM         // Employee expense claims, timesheets

  // CORPORATE_SECRETARIAL
  BIZFILE               // ACRA BizFile extracts
  RESOLUTION            // Board/shareholder resolutions
  REGISTER              // Statutory registers (members, directors, charges)
  INCORPORATION         // Constitution, incorporation cert, share certs
  ANNUAL_RETURN         // Annual returns, statutory forms
  MEETING_MINUTES       // AGM, EGM, board meeting minutes

  // CONTRACTS
  VENDOR_CONTRACT       // Supplier/service provider agreements, NDAs
  CUSTOMER_CONTRACT     // Customer/client agreements
  EMPLOYMENT_CONTRACT   // Employment agreements
  LEASE_AGREEMENT       // Property/equipment leases, licenses

  // FINANCIAL_REPORTS
  FINANCIAL_STATEMENT   // Balance sheet, P&L, cash flow
  MANAGEMENT_REPORT     // Trial balance, GL reports, management accounts
  AUDIT_REPORT          // Auditor's report, supporting schedules

  // INSURANCE
  INSURANCE_POLICY      // Policies, certificates, renewals
  INSURANCE_CLAIM       // Claim documents

  // CORRESPONDENCE
  LETTER                // Business letters, memos, notices
  EMAIL                 // Email correspondence

  // OTHER
  MISCELLANEOUS         // Documents that don't fit other categories
  SUPPORTING_DOCUMENT   // Supporting/backup documents
}

// GST Treatment
enum GstTreatment {
  STANDARD_RATED
  ZERO_RATED
  EXEMPT
  OUT_OF_SCOPE
  REVERSE_CHARGE
}

// Validation Status
enum ValidationStatus {
  PENDING
  VALID
  WARNINGS
  INVALID
}

// Exchange Rate Source
enum ExchangeRateSource {
  MAS_DAILY
  IRAS_MONTHLY_AVG
  MANUAL
  PROVIDER_DEFAULT
  DOCUMENT // Extracted from the document itself (e.g., invoice shows home currency equivalent)
}

// Rounding Mode
enum RoundingMode {
  HALF_UP
  HALF_EVEN
  DOWN
  UP
}

// Revision Posting Status
enum RevisionPostingStatus {
  NOT_POSTED
  POSTING
  POSTED
  POST_FAILED
  REVERSED
}

// Revision Reconciliation Status
enum RevisionReconciliationStatus {
  NOT_RECONCILED
  SUGGESTED
  RECONCILED
  UNRECONCILED
}

// Processing Step
enum ProcessingStep {
  FILE_VALIDATION
  RENDER
  TEXT_ACQUISITION
  SPLIT_DETECTION
  FIELD_EXTRACTION
  VALIDATION
  REVISION_CREATION
  DUPLICATE_CHECK
}

// Attempt Status
enum AttemptStatus {
  RUNNING
  SUCCEEDED
  FAILED_RETRYABLE
  FAILED_PERMANENT
}

// Split Method
enum SplitMethod {
  AUTO
  MANUAL
}

// Derived File Kind
enum DerivedFileKind {
  CHILD_PDF
  THUMBNAIL
  REDACTED_PDF
}

// Duplicate Action
enum DuplicateAction {
  CONFIRM_DUPLICATE
  REJECT_DUPLICATE
  MARK_AS_NEW_VERSION
}

// Checkpoint Status
enum CheckpointStatus {
  STARTED
  COMPLETED
  FAILED
}

// ============================================================================
// PROCESSING DOCUMENT (Extended Document Model for Processing Module)
// ============================================================================

// Processing-specific document data
model ProcessingDocument {
  id                    String              @id @default(uuid())
  documentId            String              @unique @map("document_id")
  document              Document            @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Container/child relationship
  isContainer           Boolean             @default(false) @map("is_container")
  parentProcessingDocId String?             @map("parent_processing_doc_id")
  parentProcessingDoc   ProcessingDocument? @relation("ProcessingDocumentSplit", fields: [parentProcessingDocId], references: [id])
  children              ProcessingDocument[] @relation("ProcessingDocumentSplit")

  // Page addressing (contiguous ranges only for child docs)
  pageFrom              Int?                @map("page_from") // inclusive
  pageTo                Int?                @map("page_to")   // inclusive
  pageCount             Int?                @map("page_count") // container: computed on ingestion

  // File characteristics
  fileHash              String?             @map("file_hash") // SHA-256 for duplicate detection
  perceptualHash        String?             @map("perceptual_hash") // pHash for scanned similarity
  isEncryptedPdf        Boolean             @default(false) @map("is_encrypted_pdf")
  isPasswordProtected   Boolean             @default(false) @map("is_password_protected")
  contentTypeDetected   String?             @map("content_type_detected")

  // Processing lifecycle
  pipelineStatus        PipelineStatus      @default(UPLOADED) @map("pipeline_status")
  processingPriority    ProcessingPriority  @default(NORMAL) @map("processing_priority")
  slaDeadline           DateTime?           @map("sla_deadline")

  // Error tracking
  lastError             Json?               @map("last_error")
  errorCount            Int                 @default(0) @map("error_count")
  firstErrorAt          DateTime?           @map("first_error_at")
  canRetry              Boolean             @default(true) @map("can_retry")
  nextRetryAt           DateTime?           @map("next_retry_at")
  deadLetterAt          DateTime?           @map("dead_letter_at")

  // Duplicate workflow
  duplicateStatus       DuplicateStatus     @default(NONE) @map("duplicate_status")
  duplicateOfId         String?             @map("duplicate_of_id")
  duplicateOf           ProcessingDocument? @relation("DocumentDuplicates", fields: [duplicateOfId], references: [id])
  duplicates            ProcessingDocument[] @relation("DocumentDuplicates")
  duplicateScore        Float?              @map("duplicate_score")
  duplicateReason       String?             @map("duplicate_reason")

  // Versioning (same economic document, better scan)
  rootDocumentId        String?             @map("root_document_id")
  rootDocument          ProcessingDocument? @relation("DocumentVersions", fields: [rootDocumentId], references: [id])
  versions              ProcessingDocument[] @relation("DocumentVersions")
  version               Int                 @default(1)

  // Soft delete (standardized with other entities)
  deletedAt             DateTime?           @map("deleted_at")
  deletedReason         String?             @map("deleted_reason")

  // Current revision pointer
  currentRevisionId     String?             @unique @map("current_revision_id")
  currentRevision       DocumentRevision?   @relation("CurrentRevision", fields: [currentRevisionId], references: [id])

  // Concurrency control
  lockVersion           Int                 @default(0) @map("lock_version")
  lockedById            String?             @map("locked_by_id")
  lockedAt              DateTime?           @map("locked_at")
  lockExpiresAt         DateTime?           @map("lock_expires_at")

  // Upload context
  uploadSource          UploadSource        @default(WEB) @map("upload_source")

  // Compliance
  legalHold             Boolean             @default(false) @map("legal_hold")
  retentionUntil        DateTime?           @map("retention_until")

  // Timestamps
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  pages                 DocumentPage[]
  extractions           DocumentExtraction[]
  revisions             DocumentRevision[]  @relation("DocumentRevisions")
  duplicateDecisions    DuplicateDecision[]
  processingAttempts    ProcessingAttempt[]
  processingCheckpoints ProcessingCheckpoint[]
  stateEvents           DocumentStateEvent[]
  derivedFiles          DocumentDerivedFile[]
  splitPlans            SplitPlan[]

  // Document links (for PO->DN->Invoice chains)
  linkedFrom            DocumentLink[]      @relation("DocumentLinkSource")
  linkedTo              DocumentLink[]      @relation("DocumentLinkTarget")

  // Document tags
  documentTags          ProcessingDocumentTag[]

  @@index([documentId])
  @@index([pipelineStatus])
  @@index([parentProcessingDocId])
  @@index([rootDocumentId])
  @@index([fileHash])
  @@index([pipelineStatus, nextRetryAt])
  @@index([duplicateOfId])
  @@map("processing_documents")
}

// ============================================================================
// DOCUMENT LINK - Links related documents in a transaction chain
// ============================================================================

// Link type for document relationships
enum DocumentLinkType {
  PO_TO_DN          // Purchase Order -> Delivery Note
  PO_TO_INVOICE     // Purchase Order -> Invoice
  DN_TO_INVOICE     // Delivery Note -> Invoice
  INVOICE_TO_CN     // Invoice -> Credit Note
  INVOICE_TO_DN_ADJ // Invoice -> Debit Note
  QUOTE_TO_PO       // Quotation -> Purchase Order
  CONTRACT_TO_PO    // Contract -> Purchase Order
  RELATED           // Generic related document
}

model DocumentLink {
  id                String              @id @default(uuid())

  // Source document (e.g., PO)
  sourceDocumentId  String              @map("source_document_id")
  sourceDocument    ProcessingDocument  @relation("DocumentLinkSource", fields: [sourceDocumentId], references: [id], onDelete: Cascade)

  // Target document (e.g., Invoice)
  targetDocumentId  String              @map("target_document_id")
  targetDocument    ProcessingDocument  @relation("DocumentLinkTarget", fields: [targetDocumentId], references: [id], onDelete: Cascade)

  // Link metadata
  linkType          DocumentLinkType    @map("link_type")
  notes             String?             // Optional notes about the link
  linkedById        String              @map("linked_by_id")
  linkedAt          DateTime            @default(now()) @map("linked_at")

  // Timestamps
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Prevent duplicate links
  @@unique([sourceDocumentId, targetDocumentId, linkType])
  @@index([sourceDocumentId])
  @@index([targetDocumentId])
  @@map("document_links")
}

// ============================================================================
// DOCUMENT TAG - Custom tags for organizing documents
// ============================================================================

// Predefined tag colors
enum TagColor {
  GRAY      // #6B7280 - Default/neutral
  RED       // #EF4444 - Urgent/important
  ORANGE    // #F97316 - Review needed
  AMBER     // #F59E0B - Warning/attention
  GREEN     // #22C55E - Completed/approved
  TEAL      // #14B8A6 - In progress
  BLUE      // #3B82F6 - Information
  INDIGO    // #6366F1 - Processing
  PURPLE    // #A855F7 - Special
  PINK      // #EC4899 - Highlight
}

model DocumentTag {
  id            String    @id @default(uuid())

  // Multi-tenant with optional company scope
  // companyId = NULL means tenant-level tag (shared across all companies)
  // companyId = UUID means company-specific tag
  tenantId      String    @map("tenant_id")
  companyId     String?   @map("company_id")
  company       Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Tag definition
  name          String    // e.g., "Quarterly", "Urgent", "Tax Filing"
  color         TagColor  @default(GRAY)
  description   String?   // Optional description

  // Usage tracking for "recent tags" feature
  usageCount    Int       @default(0) @map("usage_count")
  lastUsedAt    DateTime? @map("last_used_at")

  // Soft delete
  deletedAt     DateTime? @map("deleted_at")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdById   String    @map("created_by_id")

  // Relations
  documentTags  ProcessingDocumentTag[]

  // Unique tag name per tenant+company scope (handles both tenant and company tags)
  // For tenant tags: unique on [tenantId, NULL, name, deletedAt]
  // For company tags: unique on [tenantId, companyId, name, deletedAt]
  @@unique([tenantId, companyId, name, deletedAt])
  @@index([tenantId, companyId])
  @@index([tenantId, deletedAt])  // For fetching tenant tags (companyId IS NULL)
  @@index([companyId, lastUsedAt])
  @@map("document_tags")
}

model ProcessingDocumentTag {
  id                    String              @id @default(uuid())

  // Document reference
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  // Tag reference
  tagId                 String              @map("tag_id")
  tag                   DocumentTag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // Audit
  addedAt               DateTime            @default(now()) @map("added_at")
  addedById             String              @map("added_by_id")

  @@unique([processingDocumentId, tagId])
  @@index([processingDocumentId])
  @@index([tagId])
  @@map("processing_document_tags")
}

// ============================================================================
// DOCUMENT PAGE - Rendered pages for UI highlights
// ============================================================================

model DocumentPage {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  pageNumber            Int                 @map("page_number")

  // Rendered image for UI highlights
  renderDpi             Int                 @default(200) @map("render_dpi") // e.g., 200
  storageKey            String              @map("storage_key") // Storage key for page image in object storage
  imageFingerprint      String?             @map("image_fingerprint") // sha256 of rendered image bytes

  // Geometry
  widthPx               Int                 @map("width_px")
  heightPx              Int                 @map("height_px")
  rotationDeg           Int                 @default(0) @map("rotation_deg") // 0/90/180/270

  // OCR outputs
  ocrProvider           String?             @map("ocr_provider")
  ocrJson               Json?               @map("ocr_json") // Word boxes and confidence scores

  // Text acquisition decision
  textAcquisitionDecision String?           @map("text_acquisition_decision") // EMBEDDED/OCR/HYBRID
  textAcquisitionSignals  Json?             @map("text_acquisition_signals")

  createdAt             DateTime            @default(now()) @map("created_at")

  @@unique([processingDocumentId, pageNumber])
  @@index([processingDocumentId])
  @@map("document_pages")
}

// ============================================================================
// DOCUMENT EXTRACTION - Immutable AI/OCR outputs
// ============================================================================

model DocumentExtraction {
  id                      String              @id @default(uuid())
  processingDocumentId    String              @map("processing_document_id")
  processingDocument      ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  extractionType          ExtractionType      @map("extraction_type")

  // Provider details
  provider                String              // e.g., "openai", "anthropic"
  model                   String              // e.g., "gpt-4-vision"
  promptVersion           String              @map("prompt_version")
  extractionSchemaVersion String              @map("extraction_schema_version") // e.g., "1.0.0"

  // Inputs and reproducibility
  inputFingerprint        String?             @map("input_fingerprint") // hash of prompt+tools+file/page ranges
  selectorVersion         String?             @map("selector_version") // model selector version

  // Results
  rawJson                 Json                @map("raw_json")
  rawText                 String?             @map("raw_text")
  confidenceJson          Json                @map("confidence_json")
  evidenceJson            Json?               @map("evidence_json") // includes evidence per Appendix A
  overallConfidence       Float?              @map("overall_confidence")

  // Text acquisition metadata
  hasEmbeddedText         Boolean             @default(false) @map("has_embedded_text")
  textAcquisitionJson     Json?               @map("text_acquisition_json") // selector signals and per-page choice
  ocrProvider             String?             @map("ocr_provider")

  // Cost/usage
  promptTokens            Int?                @map("prompt_tokens")
  completionTokens        Int?                @map("completion_tokens")
  tokensUsed              Int?                @map("tokens_used")
  latencyMs               Int?                @map("latency_ms")
  providerRequestId       String?             @map("provider_request_id")

  createdAt               DateTime            @default(now()) @map("created_at")

  // Relations
  revisions               DocumentRevision[]

  @@index([processingDocumentId, extractionType])
  @@index([providerRequestId])
  @@map("document_extractions")
}

// ============================================================================
// DOCUMENT REVISION - Immutable snapshots of structured accounting data
// ============================================================================

model DocumentRevision {
  id                      String                      @id @default(uuid())
  processingDocumentId    String                      @map("processing_document_id")
  processingDocument      ProcessingDocument          @relation("DocumentRevisions", fields: [processingDocumentId], references: [id], onDelete: Cascade)

  // Lineage
  basedOnRevisionId       String?                     @map("based_on_revision_id")
  basedOnRevision         DocumentRevision?           @relation("RevisionChain", fields: [basedOnRevisionId], references: [id])
  derivedRevisions        DocumentRevision[]          @relation("RevisionChain")
  extractionId            String?                     @map("extraction_id")
  extraction              DocumentExtraction?         @relation(fields: [extractionId], references: [id])

  revisionNumber          Int                         @map("revision_number")
  revisionType            RevisionType                @map("revision_type")
  status                  RevisionStatus              @default(DRAFT)
  reason                  String?                     // initial_extraction, user_edit, reprocess

  // Classification
  documentCategory        DocumentCategory            @map("document_category")
  documentSubCategory     DocumentSubCategory?        @map("document_sub_category")

  // Header fields
  vendorName              String?                     @map("vendor_name")
  vendorId                String?                     @map("vendor_id")
  documentNumber          String?                     @map("document_number")
  documentDate            DateTime?                   @db.Date @map("document_date")
  dueDate                 DateTime?                   @db.Date @map("due_date")

  // Amounts (document currency)
  currency                String
  subtotal                Decimal?                    @db.Decimal(18, 4)
  taxAmount               Decimal?                    @db.Decimal(18, 4) @map("tax_amount")
  totalAmount             Decimal                     @db.Decimal(18, 4) @map("total_amount") // CREDIT_NOTE must be negative

  // Rounding policy used at approval time
  roundingMode            RoundingMode                @default(HALF_UP) @map("rounding_mode")

  // GST
  gstTreatment            GstTreatment?               @map("gst_treatment")
  supplierGstNo           String?                     @map("supplier_gst_no")

  // Currency conversion (home currency)
  homeCurrency            String?                     @map("home_currency")
  homeExchangeRateSource  ExchangeRateSource?         @map("home_exchange_rate_source")
  homeExchangeRate        Decimal?                    @db.Decimal(18, 8) @map("home_exchange_rate")
  exchangeRateDate        DateTime?                   @db.Date @map("exchange_rate_date")
  homeEquivalent          Decimal?                    @db.Decimal(18, 4) @map("home_equivalent")
  // Phase 2: Additional home currency fields
  homeSubtotal            Decimal?                    @db.Decimal(18, 4) @map("home_subtotal")
  homeTaxAmount           Decimal?                    @db.Decimal(18, 4) @map("home_tax_amount")
  isHomeExchangeRateOverride Boolean                  @default(false) @map("is_home_exchange_rate_override")

  // Validation
  validationStatus        ValidationStatus            @default(PENDING) @map("validation_status")
  validationIssues        Json?                       @map("validation_issues")

  // Document key for duplicates
  documentKey             String?                     @map("document_key")
  documentKeyVersion      String?                     @map("document_key_version") // e.g., "1"
  documentKeyConfidence   Float?                      @map("document_key_confidence")

  // Evidence for header fields
  headerEvidenceJson      Json?                       @map("header_evidence_json")

  // Posting/export lifecycle
  postingStatus           RevisionPostingStatus       @default(NOT_POSTED) @map("posting_status")
  postedAt                DateTime?                   @map("posted_at")
  postingLock             Boolean                     @default(false) @map("posting_lock") // set true when posted

  // Reconciliation lifecycle
  reconciliationStatus    RevisionReconciliationStatus @default(NOT_RECONCILED) @map("reconciliation_status")

  // Full-text search
  searchText              String?                     @map("search_text") // normalized searchable text

  // Audit fields
  createdById             String                      @map("created_by_id")
  createdAt               DateTime                    @default(now()) @map("created_at")
  approvedById            String?                     @map("approved_by_id")
  approvedAt              DateTime?                   @map("approved_at")
  supersededAt            DateTime?                   @map("superseded_at")

  // Relations
  currentForDocument      ProcessingDocument?         @relation("CurrentRevision")
  items                   DocumentRevisionLineItem[]
  matchGroupItems         MatchGroupItem[]
  postings                ExternalPosting[]

  @@unique([processingDocumentId, revisionNumber])
  @@index([processingDocumentId, status])
  @@index([vendorId])
  @@index([documentDate])
  @@index([documentKey])
  @@map("document_revisions")
}

// ============================================================================
// DOCUMENT REVISION LINE ITEM - Line items for revisions
// ============================================================================

model DocumentRevisionLineItem {
  id            String           @id @default(uuid())
  revisionId    String           @map("revision_id")
  revision      DocumentRevision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  lineNo        Int              @map("line_no")

  description   String
  quantity      Decimal?         @db.Decimal(18, 4)
  unitPrice     Decimal?         @db.Decimal(18, 4) @map("unit_price")
  amount        Decimal          @db.Decimal(18, 4)

  gstAmount     Decimal?         @db.Decimal(18, 4) @map("gst_amount")
  taxCode       String?          @map("tax_code")

  // Chart of accounts mapping
  accountCode   String?          @map("account_code")

  // Evidence for this line item
  evidenceJson  Json?            @map("evidence_json")

  // Phase 2: Home currency conversion
  homeAmount            Decimal?  @db.Decimal(18, 4) @map("home_amount")
  homeGstAmount         Decimal?  @db.Decimal(18, 4) @map("home_gst_amount")
  isHomeAmountOverride  Boolean   @default(false) @map("is_home_amount_override")
  isHomeGstOverride     Boolean   @default(false) @map("is_home_gst_override")

  @@unique([revisionId, lineNo])
  @@index([revisionId])
  @@map("document_revision_line_items")
}

// ============================================================================
// VENDOR ALIAS - Vendor name normalization
// ============================================================================

model VendorAlias {
  id                    String    @id @default(uuid())
  tenantId              String    @map("tenant_id")
  companyId             String    @map("company_id")

  rawName               String    @map("raw_name")
  normalizedContactId   String    @map("normalized_contact_id")
  confidence            Float     @default(1.0)

  createdById           String?   @map("created_by_id")
  createdAt             DateTime  @default(now()) @map("created_at")
  deletedAt             DateTime? @map("deleted_at")

  @@index([tenantId, companyId])
  @@index([companyId, rawName])
  @@map("vendor_aliases")
}

// ============================================================================
// DUPLICATE DECISION - User decisions on duplicates
// ============================================================================

model DuplicateDecision {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  suspectedOfId         String              @map("suspected_of_id")
  decision              DuplicateAction
  reason                String?

  decidedById           String              @map("decided_by_id")
  decidedAt             DateTime            @default(now()) @map("decided_at")

  @@index([processingDocumentId])
  @@index([suspectedOfId])
  @@map("duplicate_decisions")
}

// ============================================================================
// PROCESSING ATTEMPT - Tracking processing attempts for retry logic
// ============================================================================

model ProcessingAttempt {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  attemptNumber         Int                 @map("attempt_number")
  step                  ProcessingStep
  status                AttemptStatus

  startedAt             DateTime            @map("started_at")
  completedAt           DateTime?           @map("completed_at")

  errorCode             String?             @map("error_code")
  errorMessage          String?             @map("error_message")
  errorDetails          Json?               @map("error_details")

  providerLatencyMs     Int?                @map("provider_latency_ms")
  providerRequestId     String?             @map("provider_request_id")

  @@unique([processingDocumentId, attemptNumber, step])
  @@index([processingDocumentId, attemptNumber])
  @@index([status, completedAt])
  @@map("processing_attempts")
}

// ============================================================================
// PROCESSING CHECKPOINT - Checkpointing for recovery
// ============================================================================

model ProcessingCheckpoint {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  step                  ProcessingStep
  status                CheckpointStatus
  stateJson             Json?               @map("state_json") // Step-specific state for resume

  createdAt             DateTime            @default(now()) @map("created_at")

  @@unique([processingDocumentId, step])
  @@index([processingDocumentId])
  @@map("processing_checkpoints")
}

// ============================================================================
// SPLIT PLAN - Document splitting plans
// ============================================================================

model SplitPlan {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  method                SplitMethod
  schemaVersion         String              @map("schema_version") // e.g., "1.0"
  rangesJson            Json                @map("ranges_json") // ordered page ranges and metadata
  supersededAt          DateTime?           @map("superseded_at")

  createdById           String?             @map("created_by_id")
  createdAt             DateTime            @default(now()) @map("created_at")

  @@index([processingDocumentId, createdAt])
  @@map("split_plans")
}

// ============================================================================
// DOCUMENT STATE EVENT - Auditable state transitions
// ============================================================================

model DocumentStateEvent {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  eventType             String              @map("event_type") // PIPELINE_STATUS_CHANGED, LOCK_ACQUIRED, etc.
  fromState             String?             @map("from_state")
  toState               String?             @map("to_state")
  reason                String?
  metadata              Json?

  actorUserId           String?             @map("actor_user_id")
  actorServiceId        String?             @map("actor_service_id")

  createdAt             DateTime            @default(now()) @map("created_at")

  @@index([tenantId, companyId, createdAt])
  @@index([processingDocumentId, createdAt])
  @@map("document_state_events")
}

// ============================================================================
// DOCUMENT DERIVED FILE - Child PDFs, thumbnails, etc.
// ============================================================================

model DocumentDerivedFile {
  id                    String              @id @default(uuid())
  processingDocumentId  String              @map("processing_document_id")
  processingDocument    ProcessingDocument  @relation(fields: [processingDocumentId], references: [id], onDelete: Cascade)

  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  kind                  DerivedFileKind
  storageKey            String              @map("storage_key")  // Storage key in object storage
  mimeType              String              @map("mime_type")
  sizeBytes             Int?                @map("size_bytes")
  fingerprint           String?             // hash for cache/evidence compatibility

  createdAt             DateTime            @default(now()) @map("created_at")

  @@index([processingDocumentId, kind])
  @@index([tenantId, companyId, createdAt])
  @@map("document_derived_files")
}

// ============================================================================
// IDEMPOTENCY RECORD - For idempotent API operations
// ============================================================================

model IdempotencyRecord {
  key                   String              @id
  tenantId              String              @map("tenant_id")
  endpoint              String
  method                String
  requestHash           String              @map("request_hash") // Hash of request body
  response              Json
  statusCode            Int                 @map("status_code")
  expiresAt             DateTime            @map("expires_at")
  createdAt             DateTime            @default(now()) @map("created_at")

  @@index([expiresAt])
  @@index([tenantId])
  @@map("idempotency_records")
}

// ============================================================================
// WEBHOOK SUBSCRIPTION - For webhook events
// ============================================================================

model WebhookSubscription {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")

  url                   String
  events                String[]            // Array of event types
  secret                String              // Encrypted HMAC secret

  isActive              Boolean             @default(true) @map("is_active")

  // Health tracking
  lastDeliveryAt        DateTime?           @map("last_delivery_at")
  lastDeliveryStatus    String?             @map("last_delivery_status")
  failureCount          Int                 @default(0) @map("failure_count")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([isActive])
  @@map("webhook_subscriptions")
}

// ============================================================================
// DOCUMENT PROCESSING MODULE - PHASE 1B
// Multi-Currency & GST
// ============================================================================

// Exchange Rate Type
enum ExchangeRateType {
  MAS_DAILY_RATE
  MAS_MONTHLY_RATE
  MANUAL_RATE
}

// Exchange Rate - Currency conversion rates (system-wide and tenant overrides)
model ExchangeRate {
  id                    String              @id @default(uuid())

  // Scope: null = system-wide rate, tenantId = tenant-specific override
  tenantId              String?             @map("tenant_id")
  tenant                Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Currency pair
  sourceCurrency        String              @map("source_currency") // ISO 4217 (e.g., USD, EUR)
  targetCurrency        String              @default("SGD") @map("target_currency") // ISO 4217
  rate                  Decimal             @db.Decimal(18, 8)
  inverseRate           Decimal?            @db.Decimal(18, 8) @map("inverse_rate") // 1/rate for convenience
  rateDate              DateTime            @db.Date @map("rate_date")
  rateType              ExchangeRateType    @map("rate_type")

  // For manual overrides
  isManualOverride      Boolean             @default(false) @map("is_manual_override")
  manualReason          String?             @map("manual_reason")
  createdById           String?             @map("created_by_id")

  // Audit
  fetchedAt             DateTime            @default(now()) @map("fetched_at")
  sourceRef             String?             @map("source_ref") // URL or dataset identifier
  sourceHash            String?             @map("source_hash") // Checksum for audit
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@unique([tenantId, sourceCurrency, targetCurrency, rateDate, rateType])
  @@index([tenantId])
  @@index([sourceCurrency, targetCurrency, rateDate])
  @@index([rateDate])
  @@index([sourceCurrency, rateDate])
  @@map("exchange_rates")
}

// GST Filing Frequency
enum GstFilingFrequency {
  MONTHLY
  QUARTERLY
}

// ============================================================================
// DOCUMENT PROCESSING MODULE - PHASE 2
// Bank Reconciliation
// ============================================================================

// Bank Transaction Type
enum BankTransactionType {
  CREDIT
  DEBIT
  TRANSFER
  FEE
  INTEREST
  OTHER_BANK_TXN
}

// Reconciliation Status
enum ReconciliationStatus {
  UNMATCHED
  MATCH_SUGGESTED
  MATCHED
  EXCLUDED
}

// Match Type
enum MatchType {
  ONE_TO_ONE
  ONE_TO_MANY
  MANY_TO_ONE
  MANY_TO_MANY
}

// Match Method
enum MatchMethod {
  AUTO_MATCH
  MANUAL_MATCH
  RULE_BASED_MATCH
}

// Match Group Status
enum MatchGroupStatus {
  MATCH_SUGGESTED
  MATCH_CONFIRMED
  MATCH_REJECTED
}

// Period Status
enum PeriodStatus {
  PERIOD_OPEN
  PERIOD_LOCKED
  PERIOD_CLOSED
}

// Bank Account
model BankAccount {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  name                  String
  accountNumber         String              @map("account_number") // Encrypted
  currency              String              // ISO 4217 - matching basis

  // Integration
  bankProvider          String?             @map("bank_provider") // e.g., "plaid", "yodlee"
  externalId            String?             @map("external_id")
  lastSyncAt            DateTime?           @map("last_sync_at")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  deletedAt             DateTime?           @map("deleted_at")

  // Relations
  transactions          BankTransaction[]
  reconciliationPeriods ReconciliationPeriod[]

  @@index([tenantId, companyId])
  @@index([companyId])
  @@map("bank_accounts")
}

// Bank Transaction
model BankTransaction {
  id                    String              @id @default(uuid())
  bankAccountId         String              @map("bank_account_id")
  bankAccount           BankAccount         @relation(fields: [bankAccountId], references: [id])
  tenantId              String              @map("tenant_id")

  // Transaction details
  transactionDate       DateTime            @db.Date @map("transaction_date")
  valueDate             DateTime?           @db.Date @map("value_date")
  description           String
  reference             String?

  // Amount in bank account currency
  amount                Decimal             @db.Decimal(18, 4)
  currency              String              // Should match bankAccount.currency

  // Balance after transaction
  runningBalance        Decimal?            @db.Decimal(18, 4) @map("running_balance")

  // Categorization
  transactionType       BankTransactionType @map("transaction_type")

  // Import tracking
  importBatchId         String?             @map("import_batch_id")
  externalId            String?             @map("external_id")

  // Reconciliation status
  reconciliationStatus  ReconciliationStatus @default(UNMATCHED) @map("reconciliation_status")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  matchGroupItems       MatchGroupItem[]

  @@index([tenantId, bankAccountId])
  @@index([bankAccountId, transactionDate])
  @@index([bankAccountId, reconciliationStatus])
  @@index([externalId])
  @@map("bank_transactions")
}

// Match Group - Group of matched documents and transactions
model MatchGroup {
  id                      String              @id @default(uuid())
  tenantId                String              @map("tenant_id")
  companyId               String              @map("company_id")

  matchType               MatchType           @map("match_type")
  matchMethod             MatchMethod         @map("match_method")
  matchAlgorithmVersion   String              @map("match_algorithm_version")

  // Confidence and reasoning
  confidence              Float
  matchReasons            Json                @map("match_reasons") // Detailed scoring breakdown

  // Status
  status                  MatchGroupStatus    @default(MATCH_SUGGESTED)

  // FX conversion used (if applicable)
  fxConversionJson        Json?               @map("fx_conversion_json") // Rate, date, source

  // Audit
  createdAt               DateTime            @default(now()) @map("created_at")
  confirmedById           String?             @map("confirmed_by_id")
  confirmedAt             DateTime?           @map("confirmed_at")
  rejectedById            String?             @map("rejected_by_id")
  rejectedAt              DateTime?           @map("rejected_at")
  rejectionReason         String?             @map("rejection_reason")

  // Relations
  items                   MatchGroupItem[]

  @@index([tenantId, companyId])
  @@index([companyId, status])
  @@map("match_groups")
}

// Match Group Item - Individual items in a match group
model MatchGroupItem {
  id                      String              @id @default(uuid())
  matchGroupId            String              @map("match_group_id")
  matchGroup              MatchGroup          @relation(fields: [matchGroupId], references: [id], onDelete: Cascade)

  bankTransactionId       String?             @map("bank_transaction_id")
  bankTransaction         BankTransaction?    @relation(fields: [bankTransactionId], references: [id])
  documentRevisionId      String?             @map("document_revision_id")
  documentRevision        DocumentRevision?   @relation(fields: [documentRevisionId], references: [id])

  // Allocation for partial matches
  allocatedAmount         Decimal?            @db.Decimal(18, 4) @map("allocated_amount")
  allocationCurrency      String?             @map("allocation_currency")

  @@index([matchGroupId])
  @@index([bankTransactionId])
  @@index([documentRevisionId])
  @@map("match_group_items")
}

// Reconciliation Period - Lock periods for reconciliation
model ReconciliationPeriod {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")
  bankAccountId         String?             @map("bank_account_id") // Null = all accounts
  bankAccount           BankAccount?        @relation(fields: [bankAccountId], references: [id])

  periodStart           DateTime            @db.Date @map("period_start")
  periodEnd             DateTime            @db.Date @map("period_end")

  status                PeriodStatus        @default(PERIOD_OPEN)

  lockedById            String?             @map("locked_by_id")
  lockedAt              DateTime?           @map("locked_at")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@unique([companyId, bankAccountId, periodStart, periodEnd])
  @@index([tenantId, companyId])
  @@index([companyId, status])
  @@map("reconciliation_periods")
}

// ============================================================================
// DOCUMENT PROCESSING MODULE - PHASE 3
// Client Portal & Communication
// ============================================================================

// Client Request Status
enum ClientRequestStatus {
  REQUEST_PENDING
  REQUEST_IN_PROGRESS
  REQUEST_WAITING_CLIENT
  REQUEST_RESOLVED
  REQUEST_CANCELLED
}

// Request Priority
enum RequestPriority {
  PRIORITY_LOW
  PRIORITY_NORMAL
  PRIORITY_HIGH
  PRIORITY_URGENT
}

// Communication Direction
enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

// Communication Channel
enum CommunicationChannel {
  EMAIL_CHANNEL
  PORTAL_MESSAGE_CHANNEL
  SMS_CHANNEL
}

// Client Portal User - Separate from main User for security isolation
model ClientPortalUser {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  email                 String
  name                  String

  // Authentication
  passwordHash          String              @map("password_hash")
  mfaEnabled            Boolean             @default(false) @map("mfa_enabled")
  mfaSecret             String?             @map("mfa_secret") // Encrypted

  isActive              Boolean             @default(true) @map("is_active")
  lastLoginAt           DateTime?           @map("last_login_at")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  communications        Communication[]     @relation("ClientCommunications")

  @@unique([companyId, email])
  @@index([tenantId, companyId])
  @@map("client_portal_users")
}

// Client Request - Requests for documents or information
model ClientRequest {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  title                 String
  description           String?
  dueDate               DateTime?           @db.Date @map("due_date")

  status                ClientRequestStatus @default(REQUEST_PENDING)
  priority              RequestPriority     @default(PRIORITY_NORMAL)

  createdById           String              @map("created_by_id")
  createdAt             DateTime            @default(now()) @map("created_at")

  resolvedById          String?             @map("resolved_by_id")
  resolvedAt            DateTime?           @map("resolved_at")

  // Relations
  communications        Communication[]

  @@index([tenantId, companyId])
  @@index([companyId, status])
  @@map("client_requests")
}

// Communication - Messages between staff and clients
model Communication {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")
  clientRequestId       String?             @map("client_request_id")
  clientRequest         ClientRequest?      @relation(fields: [clientRequestId], references: [id])

  direction             CommunicationDirection
  channel               CommunicationChannel

  subject               String?
  body                  String

  fromUserId            String?             @map("from_user_id")
  fromClientUserId      String?             @map("from_client_user_id")
  fromClientUser        ClientPortalUser?   @relation("ClientCommunications", fields: [fromClientUserId], references: [id])
  toEmails              String[]            @map("to_emails")

  externalMessageId     String?             @map("external_message_id")
  threadId              String?             @map("thread_id")

  sentAt                DateTime?           @map("sent_at")
  readAt                DateTime?           @map("read_at")

  createdAt             DateTime            @default(now()) @map("created_at")

  @@index([tenantId, companyId])
  @@index([clientRequestId])
  @@index([threadId])
  @@map("communications")
}

// ============================================================================
// DOCUMENT PROCESSING MODULE - PHASE 4
// Accounting Software Integration
// ============================================================================

// Accounting Provider
enum AccountingProvider {
  XERO
  QUICKBOOKS
  MYOB
  SAGE
}

// Posting Status
enum PostingStatus {
  POSTING_PENDING
  POSTING_PROCESSING
  POSTING_POSTED
  POSTING_FAILED
  POSTING_SKIPPED
}

// Accounting Integration - OAuth connections to accounting software
model AccountingIntegration {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  companyId             String              @map("company_id")

  provider              AccountingProvider

  // OAuth credentials (encrypted)
  accessToken           String              @map("access_token")
  refreshToken          String?             @map("refresh_token")
  tokenExpiresAt        DateTime?           @map("token_expires_at")

  // Connection status
  isActive              Boolean             @default(true) @map("is_active")
  lastSyncAt            DateTime?           @map("last_sync_at")
  lastError             String?             @map("last_error")

  // Provider-specific settings
  settings              Json?

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  postings              ExternalPosting[]
  fieldMappings         FieldMapping[]

  @@unique([companyId, provider])
  @@index([tenantId, companyId])
  @@map("accounting_integrations")
}

// External Posting - Records of postings to accounting software
model ExternalPosting {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  documentRevisionId    String              @map("document_revision_id")
  documentRevision      DocumentRevision    @relation(fields: [documentRevisionId], references: [id])
  integrationId         String              @map("integration_id")
  integration           AccountingIntegration @relation(fields: [integrationId], references: [id])

  // Idempotency
  idempotencyKey        String              @unique @map("idempotency_key")

  // External reference
  externalId            String?             @map("external_id")
  externalType          String?             @map("external_type") // e.g., "Invoice", "Bill"
  externalUrl           String?             @map("external_url")

  // Status
  status                PostingStatus       @default(POSTING_PENDING)

  // Attempt tracking
  attemptCount          Int                 @default(0) @map("attempt_count")
  lastAttemptAt         DateTime?           @map("last_attempt_at")
  lastError             Json?               @map("last_error")

  // Timestamps
  createdAt             DateTime            @default(now()) @map("created_at")
  postedAt              DateTime?           @map("posted_at")

  @@index([tenantId, status])
  @@index([documentRevisionId])
  @@index([integrationId, status])
  @@map("external_postings")
}

// Field Mapping - Map Oakcloud fields to accounting software fields
model FieldMapping {
  id                    String              @id @default(uuid())
  integrationId         String              @map("integration_id")
  integration           AccountingIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  sourceField           String              @map("source_field") // Oakcloud field path
  targetField           String              @map("target_field") // Provider field path
  transformRule         Json?               @map("transform_rule") // Transformation logic

  isActive              Boolean             @default(true) @map("is_active")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@unique([integrationId, sourceField, targetField])
  @@index([integrationId])
  @@map("field_mappings")
}

// ============================================================================
// TENANT BACKUP SYSTEM
// ============================================================================

// Tenant Backup - Stores backup metadata and tracks backup operations
model TenantBackup {
  id                String        @id @default(uuid())
  tenantId          String        @map("tenant_id")

  // Backup metadata
  name              String?       // Optional user-friendly name
  backupType        BackupType    @default(MANUAL) @map("backup_type")
  status            BackupStatus  @default(PENDING)

  // Storage location
  storageKey        String        @map("storage_key") // e.g., "backups/{backupId}/"

  // Content tracking
  manifestJson      Json?         @map("manifest_json") // Cached manifest for quick access

  // Size tracking
  databaseSizeBytes BigInt        @default(0) @map("database_size_bytes")
  filesSizeBytes    BigInt        @default(0) @map("files_size_bytes")
  totalSizeBytes    BigInt        @default(0) @map("total_size_bytes")
  filesCount        Int           @default(0) @map("files_count")

  // Progress tracking
  progress          Int           @default(0) // 0-100
  currentStep       String?       @map("current_step") // Human-readable status

  // Error tracking
  errorMessage      String?       @map("error_message")
  errorDetails      Json?         @map("error_details")

  // Restoration tracking
  restoredAt        DateTime?     @map("restored_at")
  restoredById      String?       @map("restored_by_id")

  // Scheduling (for retention policy)
  retentionDays     Int?          @map("retention_days") // Auto-delete after N days
  expiresAt         DateTime?     @map("expires_at")

  // Audit
  createdById       String?       @map("created_by_id") // Nullable for scheduled backups
  createdAt         DateTime      @default(now()) @map("created_at")
  completedAt       DateTime?     @map("completed_at")
  deletedAt         DateTime?     @map("deleted_at")

  // Relation
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([expiresAt])
  @@map("tenant_backups")
}

// Backup Schedule - Configuration for automated backups (future use)
model BackupSchedule {
  id                String    @id @default(uuid())
  tenantId          String    @unique @map("tenant_id") // One schedule per tenant

  // Cron configuration
  cronPattern       String    @map("cron_pattern") // e.g., "0 2 * * *" for daily at 2 AM
  isEnabled         Boolean   @default(false) @map("is_enabled")
  timezone          String    @default("UTC")

  // Retention policy
  retentionDays     Int       @default(30) @map("retention_days")
  maxBackups        Int       @default(10) @map("max_backups")

  // Last run tracking
  lastRunAt         DateTime? @map("last_run_at")
  lastBackupId      String?   @map("last_backup_id")
  nextRunAt         DateTime? @map("next_run_at")

  // Error tracking
  lastError         String?   @map("last_error")
  consecutiveFailures Int     @default(0) @map("consecutive_failures")

  // Audit
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relation
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("backup_schedules")
}

// ============================================================================
// CHART OF ACCOUNTS MODULE
// ============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

// Chart of Accounts - Master account codes for document processing
// Scope: tenantId=null/companyId=null = system default
//        tenantId set/companyId=null = tenant-level account
//        tenantId set/companyId set = company-level override
model ChartOfAccount {
  id                String        @id @default(uuid())

  // Scope (nullable for hierarchical resolution: system -> tenant -> company)
  tenantId          String?       @map("tenant_id")
  tenant            Tenant?       @relation(fields: [tenantId], references: [id])
  companyId         String?       @map("company_id")
  company           Company?      @relation(fields: [companyId], references: [id])

  // Account details
  code              String        // e.g., "5000", "6100"
  name              String        // e.g., "Cost of Goods Sold"
  description       String?

  // Classification
  accountType       AccountType   @map("account_type")
  status            AccountStatus @default(ACTIVE)

  // Hierarchy (self-reference for parent-child relationships)
  parentId          String?       @map("parent_id")
  parent            ChartOfAccount? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children          ChartOfAccount[] @relation("AccountHierarchy")

  // Display & ordering
  sortOrder         Int           @default(0) @map("sort_order")

  // Flags
  isSystem          Boolean       @default(false) @map("is_system")  // Seeded account (system default)
  isTaxApplicable   Boolean       @default(true) @map("is_tax_applicable")

  // Audit
  createdById       String?       @map("created_by_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  // Relations
  externalMappings  ChartOfAccountsMapping[]

  @@unique([tenantId, companyId, code]) // Unique code per scope
  @@index([tenantId])
  @@index([companyId])
  @@index([accountType])
  @@index([parentId])
  @@index([status])
  @@index([deletedAt])
  @@index([tenantId, companyId, status, deletedAt]) // For resolved account lookups
  @@map("chart_of_accounts")
}

// Chart of Accounts Mapping - Maps internal accounts to external platform codes
// Scoped per company since each company may have different external account codes
model ChartOfAccountsMapping {
  id                String              @id @default(uuid())
  accountId         String              @map("account_id")
  account           ChartOfAccount      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Company scope (required - mappings are per company)
  companyId         String              @map("company_id")
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // External system
  provider          AccountingProvider  // XERO, QUICKBOOKS, MYOB, SAGE
  externalCode      String?             @map("external_code")     // Code in external system (optional)
  externalId        String?             @map("external_id")       // ID in external system (if applicable)
  externalName      String?             @map("external_name")     // Name in external system

  // Sync status (for future use when integrating with external platforms)
  lastSyncedAt      DateTime?           @map("last_synced_at")
  syncStatus        String?             @map("sync_status")       // e.g., "SYNCED", "PENDING", "ERROR"

  // Audit
  createdById       String?             @map("created_by_id")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  @@unique([accountId, companyId, provider])  // One mapping per provider per account per company
  @@index([accountId])
  @@index([companyId])
  @@index([provider])
  @@index([companyId, provider]) // For getting all mappings for a company by provider
  @@map("chart_of_accounts_mappings")
}
