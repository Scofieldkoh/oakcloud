generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING_SETUP
  DEACTIVATED
}

enum EntityType {
  PRIVATE_LIMITED
  PUBLIC_LIMITED
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LIMITED_PARTNERSHIP
  LIMITED_LIABILITY_PARTNERSHIP
  FOREIGN_COMPANY
  VARIABLE_CAPITAL_COMPANY
  OTHER
}

enum CompanyStatus {
  LIVE
  STRUCK_OFF
  WINDING_UP
  DISSOLVED
  IN_LIQUIDATION
  IN_RECEIVERSHIP
  AMALGAMATED
  CONVERTED
  OTHER
}

enum OfficerRole {
  DIRECTOR
  ALTERNATE_DIRECTOR
  SECRETARY
  CEO
  CFO
  AUDITOR
  LIQUIDATOR
  RECEIVER
  JUDICIAL_MANAGER
}

enum ContactType {
  INDIVIDUAL
  CORPORATE
}

enum IdentificationType {
  NRIC
  FIN
  PASSPORT
  UEN
  OTHER
}

enum AddressType {
  REGISTERED_OFFICE
  MAILING
  RESIDENTIAL
  BUSINESS
}

enum AuditAction {
  // CRUD Operations
  CREATE
  UPDATE
  DELETE
  RESTORE

  // Document Operations
  UPLOAD
  DOWNLOAD
  EXTRACT

  // Authentication Events
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  PASSWORD_CHANGE_REQUIRED
  PASSWORD_CHANGE_CLEARED

  // Access Control
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_CHANGED

  // Tenant Operations
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  USER_INVITED
  USER_REMOVED

  // User Company Assignment
  USER_COMPANY_ASSIGNED
  USER_COMPANY_UPDATED
  USER_COMPANY_REMOVED

  // Data Operations
  EXPORT
  IMPORT
  BULK_UPDATE

  // Connector Operations
  CONNECTOR_CREATED
  CONNECTOR_UPDATED
  CONNECTOR_DELETED
  CONNECTOR_TESTED
  CONNECTOR_ENABLED
  CONNECTOR_DISABLED
}

enum ChangeSource {
  MANUAL
  BIZFILE_UPLOAD
  API
  SYSTEM
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

enum ConnectorType {
  AI_PROVIDER
  STORAGE
}

enum ConnectorProvider {
  // AI Providers
  OPENAI
  ANTHROPIC
  GOOGLE
  // Storage Providers
  ONEDRIVE
}

// ============================================================================
// TENANT (Multi-Tenancy Core)
// ============================================================================

model Tenant {
  id                String       @id @default(uuid())
  name              String
  slug              String       @unique // URL-friendly identifier
  status            TenantStatus @default(PENDING_SETUP)

  // Contact Info
  contactEmail      String?
  contactPhone      String?

  // Settings & Limits
  settings          Json?        // Tenant-specific configuration
  maxUsers          Int          @default(50)
  maxCompanies      Int          @default(100)
  maxStorageMb      Int          @default(10240) // 10GB default

  // Branding (optional)
  logoUrl           String?
  primaryColor      String?      @default("#294d44")

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  deletedAt         DateTime?
  deletedReason     String?
  activatedAt       DateTime?
  suspendedAt       DateTime?
  suspendReason     String?

  // Relations
  users             User[]
  companies         Company[]
  contacts          Contact[]
  documents         Document[]
  auditLogs         AuditLog[]
  roles             Role[]
  connectors        Connector[]
  connectorAccess   TenantConnectorAccess[]
  connectorUsageLogs ConnectorUsageLog[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
  @@map("tenants")
}

// ============================================================================
// RBAC (Role-Based Access Control)
// ============================================================================

model Role {
  id          String   @id @default(uuid())
  tenantId    String?  // Nullable for global roles (SUPER_ADMIN)
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  name        String
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted

  // System role type for special handling
  // "SUPER_ADMIN" - Global admin, bypasses all checks
  // "TENANT_ADMIN" - Tenant admin, full access within tenant
  // null - Regular custom role, permissions via RolePermission
  systemRoleType String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([systemRoleType])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // e.g., "company", "document", "user", "contact"
  action      String   // e.g., "create", "read", "update", "delete", "export"
  description String?

  // Relations
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Optional: scope to specific company (null = tenant-wide)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleId, companyId])
  @@index([userId])
  @@index([roleId])
  @@index([companyId])
  @@map("user_role_assignments")
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Password management
  mustChangePassword    Boolean   @default(false)
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?
  passwordChangedAt     DateTime?

  // Tenant relation (required for all non-SUPER_ADMIN users)
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])

  // Relations
  auditLogs     AuditLog[]
  uploadedDocuments Document[]
  roleAssignments UserRoleAssignment[]
  companyAssignments UserCompanyAssignment[]
  connectorUsageLogs ConnectorUsageLog[]

  @@index([email])
  @@index([tenantId])
  @@index([passwordResetToken])
  @@map("users")
}

// User-Company many-to-many assignment for multi-company access
// Note: Permissions are controlled via UserRoleAssignment (company-scoped roles)
// This table only tracks WHICH companies a user can access
model UserCompanyAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Whether this is the user's primary company (for UI purposes)
  isPrimary Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_company_assignments")
}

// ============================================================================
// COMPANY MANAGEMENT
// ============================================================================

model Company {
  id                    String        @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id])

  uen                   String        // Unique within tenant (see compound constraint)
  name                  String
  formerName            String?       // Previous company name (if any)
  dateOfNameChange      DateTime?     // Date when name was changed
  entityType            EntityType    @default(PRIVATE_LIMITED)
  status                CompanyStatus @default(LIVE)
  statusDate            DateTime?     // Date when status became effective
  incorporationDate     DateTime?
  registrationDate      DateTime?

  // Registered Office Address Date
  dateOfAddress         DateTime?     // Date when registered address became effective

  // Business Activity
  primarySsicCode       String?
  primarySsicDescription String?
  secondarySsicCode     String?
  secondarySsicDescription String?

  // Financial Year
  financialYearEndDay   Int?
  financialYearEndMonth Int?
  fyeAsAtLastAr         DateTime?     // Financial year end as at last annual return
  homeCurrency          String?       @default("SGD")

  // Compliance Dates
  lastAgmDate           DateTime?
  lastArFiledDate       DateTime?
  nextAgmDueDate        DateTime?
  nextArDueDate         DateTime?
  accountsDueDate       DateTime?

  // Capital
  paidUpCapitalCurrency String?       @default("SGD")
  paidUpCapitalAmount   Decimal?      @db.Decimal(18, 2)
  issuedCapitalCurrency String?       @default("SGD")
  issuedCapitalAmount   Decimal?      @db.Decimal(18, 2)

  // Flags
  hasCharges            Boolean       @default(false)
  isGstRegistered       Boolean       @default(false)
  gstRegistrationNumber String?
  gstRegistrationDate   DateTime?

  // Notes
  internalNotes         String?

  // Audit & Soft Delete
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  deletedAt             DateTime?
  deletedReason         String?

  // Relations
  formerNames           CompanyFormerName[]
  addresses             CompanyAddress[]
  officers              CompanyOfficer[]
  shareholders          CompanyShareholder[]
  shareCapital          ShareCapital[]
  charges               CompanyCharge[]
  documents             Document[]
  auditLogs             AuditLog[]
  contacts              CompanyContact[]
  roleAssignments       UserRoleAssignment[]
  userAssignments       UserCompanyAssignment[]

  @@unique([tenantId, uen]) // UEN unique within tenant
  @@index([tenantId])
  @@index([uen])
  @@index([name])
  @@index([status])
  @@index([entityType])
  @@index([tenantId, deletedAt])
  @@index([deletedAt])
  @@map("companies")
}

model CompanyFormerName {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  formerName      String
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())

  @@index([companyId])
  @@map("company_former_names")
}

model CompanyAddress {
  id              String      @id @default(uuid())
  companyId       String
  company         Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addressType     AddressType
  block           String?
  streetName      String
  level           String?
  unit            String?
  buildingName    String?
  postalCode      String
  country         String      @default("SINGAPORE")
  fullAddress     String
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  isCurrent       Boolean     @default(true)
  sourceDocumentId String?
  document        Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([companyId])
  @@index([addressType])
  @@index([isCurrent])
  @@map("company_addresses")
}

// ============================================================================
// CONTACTS
// ============================================================================

model Contact {
  id                  String             @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId            String
  tenant              Tenant             @relation(fields: [tenantId], references: [id])

  contactType         ContactType        @default(INDIVIDUAL)

  // For Individuals
  firstName           String?
  lastName            String?
  fullName            String
  identificationType  IdentificationType?
  identificationNumber String?
  nationality         String?
  dateOfBirth         DateTime?

  // For Corporate
  corporateName       String?
  corporateUen        String?

  // Contact Info
  email               String?
  phone               String?

  // Address
  fullAddress         String?

  // Meta
  isActive            Boolean           @default(true)
  internalNotes       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?

  // Relations
  companyRelations    CompanyContact[]
  officerPositions    CompanyOfficer[]
  shareholdings       CompanyShareholder[]
  chargeHoldings      CompanyCharge[]

  @@unique([tenantId, identificationType, identificationNumber])
  @@index([tenantId])
  @@index([fullName])
  @@index([identificationNumber])
  @@index([corporateUen])
  @@index([tenantId, deletedAt])
  @@map("contacts")
}

model CompanyContact {
  id          String    @id @default(uuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  relationship String   // E.g., "Director", "Shareholder", "Auditor"
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // For soft delete support

  @@unique([companyId, contactId, relationship])
  @@index([companyId])
  @@index([contactId])
  @@index([deletedAt])
  @@map("company_contacts")
}

// ============================================================================
// OFFICERS
// ============================================================================

model CompanyOfficer {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  role              OfficerRole
  designation       String?     // Custom designation if needed

  // Officer Details (denormalized for historical record)
  name              String
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  address           String?

  // Appointment
  appointmentDate   DateTime?
  cessationDate     DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([role])
  @@index([isCurrent])
  @@map("company_officers")
}

// ============================================================================
// SHAREHOLDERS & CAPITAL
// ============================================================================

model ShareCapital {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  shareClass      String   @default("ORDINARY")
  currency        String   @default("SGD")
  numberOfShares  Int
  parValue        Decimal? @db.Decimal(18, 4)
  totalValue      Decimal  @db.Decimal(18, 2)
  isPaidUp        Boolean  @default(true)
  isTreasury      Boolean  @default(false)  // True for treasury shares

  effectiveDate   DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@map("share_capital")
}

model CompanyShareholder {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Shareholder Details (denormalized for historical record)
  name              String
  shareholderType   ContactType @default(INDIVIDUAL)
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  placeOfOrigin     String?     // For corporate shareholders
  address           String?

  // Shareholding
  shareClass        String      @default("ORDINARY")
  numberOfShares    Int
  percentageHeld    Decimal?    @db.Decimal(5, 2)
  currency          String      @default("SGD")

  // Dates
  allotmentDate     DateTime?
  transferDate      DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([isCurrent])
  @@map("company_shareholders")
}

// ============================================================================
// CHARGES
// ============================================================================

model CompanyCharge {
  id                String    @id @default(uuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  chargeHolderId    String?
  chargeHolder      Contact?  @relation(fields: [chargeHolderId], references: [id])

  chargeNumber      String?
  chargeType        String?
  description       String?
  chargeHolderName  String
  amountSecured     Decimal?  @db.Decimal(18, 2)
  amountSecuredText String?   // For text values like "All Monies"
  currency          String?   @default("SGD")

  registrationDate  DateTime?
  dischargeDate     DateTime?
  isFullyDischarged Boolean   @default(false)

  sourceDocumentId  String?
  document          Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([chargeHolderId])
  @@index([isFullyDischarged])
  @@map("company_charges")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model Document {
  id              String    @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  // Company is optional for pending documents (e.g., BizFile upload before extraction)
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User      @relation(fields: [uploadedById], references: [id])

  documentType    String    // "BIZFILE", "CONSTITUTION", "RESOLUTION", etc.
  fileName        String
  originalFileName String
  filePath        String
  fileSize        Int
  mimeType        String

  // Extraction
  extractedAt     DateTime?
  extractionStatus String?   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  extractionError String?
  extractedData   Json?     // Raw extracted JSON data

  // Versioning
  version         Int       @default(1)
  isLatest        Boolean   @default(true)
  previousVersionId String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations - data extracted from this document
  formerNames     CompanyFormerName[]
  addresses       CompanyAddress[]
  officers        CompanyOfficer[]
  shareCapital    ShareCapital[]
  shareholders    CompanyShareholder[]
  charges         CompanyCharge[]

  @@index([tenantId])
  @@index([companyId])
  @@index([documentType])
  @@index([uploadedById])
  @@index([tenantId, companyId])
  @@map("documents")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id            String       @id @default(uuid())

  // Tenant (multi-tenancy) - optional for system-level events
  tenantId      String?
  tenant        Tenant?      @relation(fields: [tenantId], references: [id])

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])
  companyId     String?
  company       Company?     @relation(fields: [companyId], references: [id])

  action        AuditAction
  entityType    String       // "Tenant", "Company", "Contact", "Officer", etc.
  entityId      String

  changeSource  ChangeSource @default(MANUAL)
  changes       Json?        // { field: { old: value, new: value } }
  reason        String?      // Required for deletions
  summary       String?      // Human-readable description of the action
  entityName    String?      // Name of the affected entity (e.g., company name, user name)
  metadata      Json?        // Additional context

  // Request context
  ipAddress     String?
  userAgent     String?
  requestId     String?      // For correlating related operations
  sessionId     String?      // For tracking user sessions

  // Timestamps
  createdAt     DateTime     @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType])
  @@index([requestId])
  @@map("audit_logs")
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

model Connector {
  id                String            @id @default(uuid())

  // Tenant scope: null = system connector, otherwise tenant-specific
  tenantId          String?
  tenant            Tenant?           @relation(fields: [tenantId], references: [id])

  // Connector identification
  name              String            // Display name (e.g., "Production OpenAI")
  type              ConnectorType     // AI_PROVIDER, STORAGE
  provider          ConnectorProvider // OPENAI, ANTHROPIC, GOOGLE, ONEDRIVE

  // Configuration
  credentials       String            // Encrypted JSON: { apiKey, clientId, etc. }
  settings          Json?             // Provider-specific settings (model preferences, etc.)

  // Status
  isEnabled         Boolean           @default(true)
  isDefault         Boolean           @default(false) // Default for this type within scope

  // Usage tracking
  callCount         Int               @default(0)
  lastUsedAt        DateTime?
  lastTestedAt      DateTime?
  lastTestResult    String?           // "success" | "error:message"

  // Soft delete & timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  // Relations
  tenantAccess      TenantConnectorAccess[]
  usageLogs         ConnectorUsageLog[]

  @@unique([tenantId, provider, deletedAt])
  @@index([tenantId])
  @@index([type])
  @@index([provider])
  @@index([isEnabled])
  @@index([deletedAt])
  @@map("connectors")
}

// Per-tenant access control for system connectors
model TenantConnectorAccess {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  isEnabled     Boolean   @default(true)  // false = blocked for this tenant

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, connectorId])
  @@index([tenantId])
  @@index([connectorId])
  @@map("tenant_connector_access")
}

// Detailed usage logging for connectors
model ConnectorUsageLog {
  id            String    @id @default(uuid())

  // References
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  tenantId      String?   // Tenant that made the call (for billing attribution)
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userId        String?   // User who triggered the call
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // AI Model details
  model         String    // Model ID used (e.g., "gpt-4.1", "claude-sonnet-4.5")
  provider      String    // Provider name (openai, anthropic, google)

  // Token usage
  inputTokens   Int       @default(0)
  outputTokens  Int       @default(0)
  totalTokens   Int       @default(0)

  // Cost calculation (in USD cents for precision)
  costCents     Int       @default(0) // Total cost in cents (e.g., 150 = $1.50)

  // Performance
  latencyMs     Int?      // Response time in milliseconds

  // Request details
  operation     String?   // e.g., "bizfile_extraction", "document_analysis"
  success       Boolean   @default(true)
  errorMessage  String?   // Error details if failed

  // Metadata
  metadata      Json?     // Additional context (document ID, company ID, etc.)

  createdAt     DateTime  @default(now())

  @@index([connectorId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@index([connectorId, createdAt])
  @@index([tenantId, createdAt])
  @@map("connector_usage_logs")
}
