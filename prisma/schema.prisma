generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING_SETUP
  DEACTIVATED
}

enum EntityType {
  PRIVATE_LIMITED
  EXEMPTED_PRIVATE_LIMITED
  PUBLIC_LIMITED
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LIMITED_PARTNERSHIP
  LIMITED_LIABILITY_PARTNERSHIP
  FOREIGN_COMPANY
  VARIABLE_CAPITAL_COMPANY
  OTHER
}

enum CompanyStatus {
  LIVE
  STRUCK_OFF
  WINDING_UP
  DISSOLVED
  IN_LIQUIDATION
  IN_RECEIVERSHIP
  AMALGAMATED
  CONVERTED
  OTHER
}

enum OfficerRole {
  DIRECTOR
  MANAGING_DIRECTOR
  ALTERNATE_DIRECTOR
  SECRETARY
  CEO
  CFO
  AUDITOR
  LIQUIDATOR
  RECEIVER
  JUDICIAL_MANAGER
}

enum ContactType {
  INDIVIDUAL
  CORPORATE
}

enum IdentificationType {
  NRIC
  FIN
  PASSPORT
  UEN
  OTHER
}

enum AddressType {
  REGISTERED_OFFICE
  MAILING
  RESIDENTIAL
  BUSINESS
}

enum AuditAction {
  // CRUD Operations
  CREATE
  UPDATE
  DELETE
  RESTORE

  // Document Operations
  UPLOAD
  DOWNLOAD
  EXTRACT

  // Authentication Events
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  PASSWORD_CHANGE_REQUIRED
  PASSWORD_CHANGE_CLEARED

  // Access Control
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_CHANGED

  // Tenant Operations
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  USER_INVITED
  USER_REMOVED

  // User Company Assignment
  USER_COMPANY_ASSIGNED
  USER_COMPANY_UPDATED
  USER_COMPANY_REMOVED

  // Data Operations
  EXPORT
  IMPORT
  BULK_UPDATE

  // Connector Operations
  CONNECTOR_CREATED
  CONNECTOR_UPDATED
  CONNECTOR_DELETED
  CONNECTOR_TESTED
  CONNECTOR_ENABLED
  CONNECTOR_DISABLED

  // Document Generation Module
  DOCUMENT_TEMPLATE_CREATED
  DOCUMENT_TEMPLATE_UPDATED
  DOCUMENT_TEMPLATE_DELETED
  DOCUMENT_TEMPLATE_DUPLICATED
  DOCUMENT_GENERATED
  DOCUMENT_FINALIZED
  DOCUMENT_UNFINALIZED
  DOCUMENT_ARCHIVED
  DOCUMENT_CLONED
  SHARE_LINK_CREATED
  SHARE_LINK_REVOKED
  LETTERHEAD_UPDATED
  COMMENT_CREATED
  COMMENT_RESOLVED
  COMMENT_HIDDEN
}

enum ChangeSource {
  MANUAL
  BIZFILE_UPLOAD
  API
  SYSTEM
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

enum ConnectorType {
  AI_PROVIDER
  STORAGE
}

enum ConnectorProvider {
  // AI Providers
  OPENAI
  ANTHROPIC
  GOOGLE
  // Storage Providers
  ONEDRIVE
}

// ============================================================================
// TENANT (Multi-Tenancy Core)
// ============================================================================

model Tenant {
  id                String       @id @default(uuid())
  name              String
  slug              String       @unique // URL-friendly identifier
  status            TenantStatus @default(PENDING_SETUP)

  // Contact Info
  contactEmail      String?
  contactPhone      String?

  // Settings & Limits
  settings          Json?        // Tenant-specific configuration
  maxUsers          Int          @default(50)
  maxCompanies      Int          @default(100)
  maxStorageMb      Int          @default(10240) // 10GB default

  // Branding (optional)
  logoUrl           String?
  primaryColor      String?      @default("#294d44")

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  deletedAt         DateTime?
  deletedReason     String?
  activatedAt       DateTime?
  suspendedAt       DateTime?
  suspendReason     String?

  // Relations
  users             User[]
  companies         Company[]
  contacts          Contact[]
  documents         Document[]
  auditLogs         AuditLog[]
  roles             Role[]
  connectors        Connector[]
  connectorAccess   TenantConnectorAccess[]
  connectorUsageLogs ConnectorUsageLog[]

  // Document Generation Module
  documentTemplates    DocumentTemplate[]
  generatedDocuments   GeneratedDocument[]
  letterhead           TenantLetterhead?
  templatePartials     TemplatePartial[]
  aiConversations      AiConversation[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
  @@map("tenants")
}

// ============================================================================
// RBAC (Role-Based Access Control)
// ============================================================================

model Role {
  id          String   @id @default(uuid())
  tenantId    String?  // Nullable for global roles (SUPER_ADMIN)
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  name        String
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted

  // System role type for special handling
  // "SUPER_ADMIN" - Global admin, bypasses all checks
  // "TENANT_ADMIN" - Tenant admin, full access within tenant
  // null - Regular custom role, permissions via RolePermission
  systemRoleType String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([systemRoleType])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // e.g., "company", "document", "user", "contact"
  action      String   // e.g., "create", "read", "update", "delete", "export"
  description String?

  // Relations
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Optional: scope to specific company (null = tenant-wide)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleId, companyId])
  @@index([userId])
  @@index([roleId])
  @@index([companyId])
  @@index([userId, roleId, companyId]) // Composite index for permission checks
  @@map("user_role_assignments")
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Password management
  mustChangePassword    Boolean   @default(false)
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?
  passwordChangedAt     DateTime?

  // Tenant relation (required for all non-SUPER_ADMIN users)
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])

  // Relations
  auditLogs     AuditLog[]
  uploadedDocuments Document[]
  roleAssignments UserRoleAssignment[]
  companyAssignments UserCompanyAssignment[]
  connectorUsageLogs ConnectorUsageLog[]

  // Document Generation Module
  createdTemplates      DocumentTemplate[]    @relation("TemplateCreator")
  createdDocuments      GeneratedDocument[]   @relation("DocumentCreator")
  finalizedDocuments    GeneratedDocument[]   @relation("DocumentFinalizer")
  createdShares         DocumentShare[]       @relation("ShareCreator")
  authoredComments      DocumentComment[]     @relation("CommentAuthor")
  resolvedComments      DocumentComment[]     @relation("CommentResolver")
  hiddenComments        DocumentComment[]     @relation("CommentHider")
  documentDrafts        DocumentDraft[]       @relation("DraftAuthor")
  createdPartials       TemplatePartial[]     @relation("PartialCreator")
  aiConversations       AiConversation[]      @relation("ConversationOwner")

  @@index([email])
  @@index([tenantId])
  @@index([passwordResetToken])
  @@map("users")
}

// User-Company many-to-many assignment for multi-company access
// Note: Permissions are controlled via UserRoleAssignment (company-scoped roles)
// This table only tracks WHICH companies a user can access
model UserCompanyAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Whether this is the user's primary company (for UI purposes)
  isPrimary Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_company_assignments")
}

// ============================================================================
// COMPANY MANAGEMENT
// ============================================================================

model Company {
  id                    String        @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id])

  uen                   String        // Unique within tenant (see compound constraint)
  name                  String
  formerName            String?       // Previous company name (if any)
  dateOfNameChange      DateTime?     // Date when name was changed
  entityType            EntityType    @default(PRIVATE_LIMITED)
  status                CompanyStatus @default(LIVE)
  statusDate            DateTime?     // Date when status became effective
  incorporationDate     DateTime?
  registrationDate      DateTime?

  // Registered Office Address Date
  dateOfAddress         DateTime?     // Date when registered address became effective

  // Business Activity
  primarySsicCode       String?
  primarySsicDescription String?
  secondarySsicCode     String?
  secondarySsicDescription String?

  // Financial Year
  financialYearEndDay   Int?
  financialYearEndMonth Int?
  fyeAsAtLastAr         DateTime?     // Financial year end as at last annual return
  homeCurrency          String?       @default("SGD")

  // Compliance Dates
  lastAgmDate           DateTime?
  lastArFiledDate       DateTime?
  nextAgmDueDate        DateTime?
  nextArDueDate         DateTime?
  accountsDueDate       DateTime?

  // Capital
  paidUpCapitalCurrency String?       @default("SGD")
  paidUpCapitalAmount   Decimal?      @db.Decimal(18, 2)
  issuedCapitalCurrency String?       @default("SGD")
  issuedCapitalAmount   Decimal?      @db.Decimal(18, 2)

  // Flags
  hasCharges            Boolean       @default(false)
  isGstRegistered       Boolean       @default(false)
  gstRegistrationNumber String?
  gstRegistrationDate   DateTime?

  // Audit & Soft Delete
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  deletedAt             DateTime?
  deletedReason         String?

  // Relations
  formerNames           CompanyFormerName[]
  addresses             CompanyAddress[]
  officers              CompanyOfficer[]
  shareholders          CompanyShareholder[]
  shareCapital          ShareCapital[]
  charges               CompanyCharge[]
  documents             Document[]
  auditLogs             AuditLog[]
  contacts              CompanyContact[]
  roleAssignments       UserRoleAssignment[]
  userAssignments       UserCompanyAssignment[]
  noteTabs              NoteTab[]

  // Document Generation Module
  generatedDocuments    GeneratedDocument[]

  @@unique([tenantId, uen]) // UEN unique within tenant
  @@index([tenantId])
  @@index([uen])
  @@index([name])
  @@index([status])
  @@index([entityType])
  @@index([tenantId, deletedAt])
  @@index([deletedAt])
  @@map("companies")
}

model CompanyFormerName {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  formerName      String
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())

  @@index([companyId])
  @@map("company_former_names")
}

model CompanyAddress {
  id              String      @id @default(uuid())
  companyId       String
  company         Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  addressType     AddressType
  block           String?
  streetName      String
  level           String?
  unit            String?
  buildingName    String?
  postalCode      String
  country         String      @default("SINGAPORE")
  fullAddress     String
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  isCurrent       Boolean     @default(true)
  sourceDocumentId String?
  document        Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([companyId])
  @@index([addressType])
  @@index([isCurrent])
  @@map("company_addresses")
}

// ============================================================================
// CONTACTS
// ============================================================================

model Contact {
  id                  String             @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId            String
  tenant              Tenant             @relation(fields: [tenantId], references: [id])

  contactType         ContactType        @default(INDIVIDUAL)

  // For Individuals
  firstName           String?
  lastName            String?
  fullName            String
  identificationType  IdentificationType?
  identificationNumber String?
  nationality         String?
  dateOfBirth         DateTime?

  // For Corporate
  corporateName       String?
  corporateUen        String?

  // Contact Info
  email               String?
  phone               String?

  // Address
  fullAddress         String?

  // Meta
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?

  // Relations
  companyRelations    CompanyContact[]
  officerPositions    CompanyOfficer[]
  shareholdings       CompanyShareholder[]
  chargeHoldings      CompanyCharge[]
  noteTabs            NoteTab[]

  @@unique([tenantId, identificationType, identificationNumber])
  @@index([tenantId])
  @@index([fullName])
  @@index([identificationNumber])
  @@index([corporateUen])
  @@index([tenantId, deletedAt])
  @@map("contacts")
}

model CompanyContact {
  id          String    @id @default(uuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  relationship String   // E.g., "Director", "Shareholder", "Auditor"
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // For soft delete support

  @@unique([companyId, contactId, relationship])
  @@index([companyId])
  @@index([contactId])
  @@index([deletedAt])
  @@map("company_contacts")
}

// ============================================================================
// OFFICERS
// ============================================================================

model CompanyOfficer {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  role              OfficerRole

  // Officer Details (denormalized for historical record)
  name              String
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  address           String?

  // Appointment
  appointmentDate   DateTime?
  cessationDate     DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([role])
  @@index([isCurrent])
  @@map("company_officers")
}

// ============================================================================
// SHAREHOLDERS & CAPITAL
// ============================================================================

model ShareCapital {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  shareClass      String   @default("ORDINARY")
  currency        String   @default("SGD")
  numberOfShares  Int
  parValue        Decimal? @db.Decimal(18, 4)
  totalValue      Decimal  @db.Decimal(18, 2)
  isPaidUp        Boolean  @default(true)
  isTreasury      Boolean  @default(false)  // True for treasury shares

  effectiveDate   DateTime?
  sourceDocumentId String?
  document        Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@map("share_capital")
}

model CompanyShareholder {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Shareholder Details (denormalized for historical record)
  name              String
  shareholderType   ContactType @default(INDIVIDUAL)
  identificationType IdentificationType?
  identificationNumber String?
  nationality       String?
  placeOfOrigin     String?     // For corporate shareholders
  address           String?

  // Shareholding
  shareClass        String      @default("ORDINARY")
  numberOfShares    Int
  percentageHeld    Decimal?    @db.Decimal(5, 2)
  currency          String      @default("SGD")

  // Dates
  allotmentDate     DateTime?
  transferDate      DateTime?
  isCurrent         Boolean     @default(true)

  // Source
  sourceDocumentId  String?
  document          Document?   @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([isCurrent])
  @@map("company_shareholders")
}

// ============================================================================
// CHARGES
// ============================================================================

model CompanyCharge {
  id                String    @id @default(uuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  chargeHolderId    String?
  chargeHolder      Contact?  @relation(fields: [chargeHolderId], references: [id])

  chargeNumber      String?
  chargeType        String?
  description       String?
  chargeHolderName  String
  amountSecured     Decimal?  @db.Decimal(18, 2)
  amountSecuredText String?   // For text values like "All Monies"
  currency          String?   @default("SGD")

  registrationDate  DateTime?
  dischargeDate     DateTime?
  isFullyDischarged Boolean   @default(false)

  sourceDocumentId  String?
  document          Document? @relation(fields: [sourceDocumentId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([chargeHolderId])
  @@index([isFullyDischarged])
  @@map("company_charges")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model Document {
  id              String    @id @default(uuid())

  // Tenant (multi-tenancy) - required
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  // Company is optional for pending documents (e.g., BizFile upload before extraction)
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User      @relation(fields: [uploadedById], references: [id])

  documentType    String    // "BIZFILE", "CONSTITUTION", "RESOLUTION", etc.
  fileName        String
  originalFileName String
  filePath        String
  fileSize        Int
  mimeType        String

  // Extraction
  extractedAt     DateTime?
  extractionStatus String?   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  extractionError String?
  extractedData   Json?     // Raw extracted JSON data

  // Versioning
  version         Int       @default(1)
  isLatest        Boolean   @default(true)
  previousVersionId String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations - data extracted from this document
  formerNames     CompanyFormerName[]
  addresses       CompanyAddress[]
  officers        CompanyOfficer[]
  shareCapital    ShareCapital[]
  shareholders    CompanyShareholder[]
  charges         CompanyCharge[]

  @@index([tenantId])
  @@index([companyId])
  @@index([documentType])
  @@index([uploadedById])
  @@index([tenantId, companyId])
  @@map("documents")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id            String       @id @default(uuid())

  // Tenant (multi-tenancy) - optional for system-level events
  tenantId      String?
  tenant        Tenant?      @relation(fields: [tenantId], references: [id])

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])
  companyId     String?
  company       Company?     @relation(fields: [companyId], references: [id])

  action        AuditAction
  entityType    String       // "Tenant", "Company", "Contact", "Officer", etc.
  entityId      String

  changeSource  ChangeSource @default(MANUAL)
  changes       Json?        // { field: { old: value, new: value } }
  reason        String?      // Required for deletions
  summary       String?      // Human-readable description of the action
  entityName    String?      // Name of the affected entity (e.g., company name, user name)
  metadata      Json?        // Additional context

  // Request context
  ipAddress     String?
  userAgent     String?
  requestId     String?      // For correlating related operations
  sessionId     String?      // For tracking user sessions

  // Timestamps
  createdAt     DateTime     @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType])
  @@index([requestId])
  @@map("audit_logs")
}

// ============================================================================
// CONNECTORS HUB
// ============================================================================

model Connector {
  id                String            @id @default(uuid())

  // Tenant scope: null = system connector, otherwise tenant-specific
  tenantId          String?
  tenant            Tenant?           @relation(fields: [tenantId], references: [id])

  // Connector identification
  name              String            // Display name (e.g., "Production OpenAI")
  type              ConnectorType     // AI_PROVIDER, STORAGE
  provider          ConnectorProvider // OPENAI, ANTHROPIC, GOOGLE, ONEDRIVE

  // Configuration
  credentials       String            // Encrypted JSON: { apiKey, clientId, etc. }
  settings          Json?             // Provider-specific settings (model preferences, etc.)

  // Status
  isEnabled         Boolean           @default(true)
  isDefault         Boolean           @default(false) // Default for this type within scope

  // Usage tracking
  callCount         Int               @default(0)
  lastUsedAt        DateTime?
  lastTestedAt      DateTime?
  lastTestResult    String?           // "success" | "error:message"

  // Soft delete & timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  // Relations
  tenantAccess      TenantConnectorAccess[]
  usageLogs         ConnectorUsageLog[]

  @@unique([tenantId, provider, deletedAt])
  @@index([tenantId])
  @@index([type])
  @@index([provider])
  @@index([isEnabled])
  @@index([deletedAt])
  @@map("connectors")
}

// Per-tenant access control for system connectors
model TenantConnectorAccess {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  isEnabled     Boolean   @default(true)  // false = blocked for this tenant

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, connectorId])
  @@index([tenantId])
  @@index([connectorId])
  @@map("tenant_connector_access")
}

// Detailed usage logging for connectors
model ConnectorUsageLog {
  id            String    @id @default(uuid())

  // References
  connectorId   String
  connector     Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  tenantId      String?   // Tenant that made the call (for billing attribution)
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userId        String?   // User who triggered the call
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // AI Model details
  model         String    // Model ID used (e.g., "gpt-4.1", "claude-sonnet-4.5")
  provider      String    // Provider name (openai, anthropic, google)

  // Token usage
  inputTokens   Int       @default(0)
  outputTokens  Int       @default(0)
  totalTokens   Int       @default(0)

  // Cost calculation (in USD cents for precision)
  costCents     Int       @default(0) // Total cost in cents (e.g., 150 = $1.50)

  // Performance
  latencyMs     Int?      // Response time in milliseconds

  // Request details
  operation     String?   // e.g., "bizfile_extraction", "document_analysis"
  success       Boolean   @default(true)
  errorMessage  String?   // Error details if failed

  // Metadata
  metadata      Json?     // Additional context (document ID, company ID, etc.)

  createdAt     DateTime  @default(now())

  @@index([connectorId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@index([connectorId, createdAt])
  @@index([tenantId, createdAt])
  @@map("connector_usage_logs")
}

// ============================================================================
// INTERNAL NOTES (Multi-Tab Rich Text Notes)
// ============================================================================

model NoteTab {
  id        String   @id @default(uuid())
  title     String   @default("General")
  content   String?  @db.Text  // Rich text HTML content
  order     Int      @default(0)

  // Relations (one of these will be set)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([order])
  @@map("note_tabs")
}

// ============================================================================
// DOCUMENT GENERATION MODULE
// ============================================================================

enum DocumentTemplateCategory {
  RESOLUTION
  CONTRACT
  LETTER
  MINUTES
  NOTICE
  CERTIFICATE
  OTHER
}

enum GeneratedDocumentStatus {
  DRAFT
  FINALIZED
  ARCHIVED
}

enum DocumentCommentStatus {
  OPEN
  RESOLVED
}

// Document Templates - Reusable templates with placeholders
model DocumentTemplate {
  id                    String                   @id @default(uuid())
  tenantId              String                   @map("tenant_id")
  tenant                Tenant                   @relation(fields: [tenantId], references: [id])

  name                  String                   @db.VarChar(200)
  description           String?                  @db.Text
  category              DocumentTemplateCategory @default(OTHER)
  content               String                   @db.Text // HTML content with placeholders
  contentJson           Json?                    @map("content_json") // TipTap JSON format
  placeholders          Json                     @default("[]") // Array of placeholder definitions
  isActive              Boolean                  @default(true) @map("is_active")
  defaultShareExpiryHours Int?                   @map("default_share_expiry_hours")
  version               Int                      @default(1)

  // Audit
  createdById           String                   @map("created_by_id")
  createdBy             User                     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")
  deletedAt             DateTime?                @map("deleted_at")

  // Relations
  generatedDocuments    GeneratedDocument[]

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
  @@index([tenantId, deletedAt])
  @@map("document_templates")
}

// Generated Documents - Documents created from templates
model GeneratedDocument {
  id                    String                   @id @default(uuid())
  tenantId              String                   @map("tenant_id")
  tenant                Tenant                   @relation(fields: [tenantId], references: [id])

  // Source template (nullable for documents without template)
  templateId            String?                  @map("template_id")
  template              DocumentTemplate?        @relation(fields: [templateId], references: [id])
  templateVersion       Int?                     @map("template_version") // Snapshot of template version used

  // Associated company (optional)
  companyId             String?                  @map("company_id")
  company               Company?                 @relation(fields: [companyId], references: [id])

  // Document content
  title                 String                   @db.VarChar(300)
  content               String                   @db.Text // Resolved HTML content
  contentJson           Json?                    @map("content_json") // TipTap JSON format
  status                GeneratedDocumentStatus  @default(DRAFT)

  // Finalization tracking
  finalizedAt           DateTime?                @map("finalized_at")
  finalizedById         String?                  @map("finalized_by_id")
  finalizedBy           User?                    @relation("DocumentFinalizer", fields: [finalizedById], references: [id])
  unfinalizedAt         DateTime?                @map("unfinalized_at") // Last time un-finalized

  // PDF options
  useLetterhead         Boolean                  @default(true) @map("use_letterhead")
  shareExpiryHours      Int?                     @map("share_expiry_hours") // Override template default

  // Metadata
  placeholderData       Json?                    @map("placeholder_data") // Snapshot of data used
  metadata              Json?                    // Additional metadata

  // Audit
  createdById           String                   @map("created_by_id")
  createdBy             User                     @relation("DocumentCreator", fields: [createdById], references: [id])
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")
  deletedAt             DateTime?                @map("deleted_at")

  // Relations
  sections              DocumentSection[]
  shares                DocumentShare[]
  comments              DocumentComment[]
  drafts                DocumentDraft[]

  @@index([tenantId])
  @@index([templateId])
  @@index([companyId])
  @@index([status])
  @@index([createdById])
  @@index([tenantId, deletedAt])
  @@map("generated_documents")
}

// Document Sections - For navigation sidebar
model DocumentSection {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  title                 String            @db.VarChar(200)
  anchor                String            @db.VarChar(100) // HTML anchor ID
  order                 Int
  level                 Int               @default(1) // Heading level (1, 2, 3)
  pageBreakBefore       Boolean           @default(false) @map("page_break_before")

  createdAt             DateTime          @default(now()) @map("created_at")

  @@index([documentId])
  @@index([documentId, order])
  @@map("document_sections")
}

// Document Shares - Shareable links with access control
model DocumentShare {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  shareToken            String            @unique @map("share_token") @db.VarChar(64)
  expiresAt             DateTime?         @map("expires_at")
  passwordHash          String?           @map("password_hash") @db.VarChar(255)
  isActive              Boolean           @default(true) @map("is_active")

  // Access tracking
  viewCount             Int               @default(0) @map("view_count")
  lastViewedAt          DateTime?         @map("last_viewed_at")

  // Permissions
  allowedActions        String[]          @default(["view"]) @map("allowed_actions") // view, download, print
  allowComments         Boolean           @default(false) @map("allow_comments")
  commentRateLimit      Int               @default(20) @map("comment_rate_limit") // Max comments/hour/IP
  notifyOnComment       Boolean           @default(false) @map("notify_on_comment")
  notifyOnView          Boolean           @default(false) @map("notify_on_view")

  // Audit
  createdById           String            @map("created_by_id")
  createdBy             User              @relation("ShareCreator", fields: [createdById], references: [id])
  createdAt             DateTime          @default(now()) @map("created_at")
  revokedAt             DateTime?         @map("revoked_at")

  // Relations
  comments              DocumentComment[]

  @@index([documentId])
  @@index([expiresAt])
  @@index([shareToken])
  @@index([shareToken, isActive]) // Composite index for share validation
  @@map("document_shares")
}

// Tenant Letterheads - PDF letterhead configuration
model TenantLetterhead {
  id                    String   @id @default(uuid())
  tenantId              String   @unique @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id])

  headerHtml            String?  @map("header_html") @db.Text
  footerHtml            String?  @map("footer_html") @db.Text
  headerImageUrl        String?  @map("header_image_url") @db.VarChar(500)
  footerImageUrl        String?  @map("footer_image_url") @db.VarChar(500)
  logoUrl               String?  @map("logo_url") @db.VarChar(500)
  pageMargins           Json     @default("{\"top\": 25, \"right\": 20, \"bottom\": 25, \"left\": 20}") @map("page_margins")
  isEnabled             Boolean  @default(true) @map("is_enabled")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("tenant_letterheads")
}

// Document Comments - Internal & external comments with text selection
model DocumentComment {
  id                    String               @id @default(uuid())
  documentId            String               @map("document_id")
  document              GeneratedDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // For external comments via share link
  shareId               String?              @map("share_id")
  share                 DocumentShare?       @relation(fields: [shareId], references: [id])

  // Internal user (null for external commenters)
  userId                String?              @map("user_id")
  user                  User?                @relation("CommentAuthor", fields: [userId], references: [id])

  // External commenter info
  guestName             String?              @map("guest_name") @db.VarChar(100)
  guestEmail            String?              @map("guest_email") @db.VarChar(255)

  // Comment content (max 1000 chars)
  content               String               @db.VarChar(1000)

  // Text selection (for linked comments)
  selectionStart        Int?                 @map("selection_start")
  selectionEnd          Int?                 @map("selection_end")
  selectedText          String?              @map("selected_text") @db.Text

  // Threading
  parentId              String?              @map("parent_id")
  parent                DocumentComment?     @relation("CommentReplies", fields: [parentId], references: [id])
  replies               DocumentComment[]    @relation("CommentReplies")

  // Status
  status                DocumentCommentStatus @default(OPEN)
  resolvedById          String?              @map("resolved_by_id")
  resolvedBy            User?                @relation("CommentResolver", fields: [resolvedById], references: [id])
  resolvedAt            DateTime?            @map("resolved_at")

  // Moderation
  hiddenAt              DateTime?            @map("hidden_at")
  hiddenById            String?              @map("hidden_by_id")
  hiddenBy              User?                @relation("CommentHider", fields: [hiddenById], references: [id])
  hiddenReason          String?              @map("hidden_reason") @db.VarChar(255)

  // Rate limiting
  ipAddress             String?              @map("ip_address") @db.VarChar(45)

  // Timestamps
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  deletedAt             DateTime?            @map("deleted_at")

  @@index([documentId])
  @@index([shareId])
  @@index([userId])
  @@index([parentId])
  @@index([status])
  @@index([ipAddress, createdAt])
  @@map("document_comments")
}

// Document Drafts - Auto-save storage
model DocumentDraft {
  id                    String            @id @default(uuid())
  documentId            String            @map("document_id")
  document              GeneratedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId                String            @map("user_id")
  user                  User              @relation("DraftAuthor", fields: [userId], references: [id])

  content               String            @db.Text
  contentJson           Json?             @map("content_json")
  metadata              Json?

  createdAt             DateTime          @default(now()) @map("created_at")

  @@index([documentId])
  @@index([userId, createdAt])
  @@map("document_drafts")
}

// Template Partials - Reusable template blocks (Phase 7)
model TemplatePartial {
  id                    String    @id @default(uuid())
  tenantId              String    @map("tenant_id")
  tenant                Tenant    @relation(fields: [tenantId], references: [id])

  name                  String    @db.VarChar(100)  // Identifier used in {{>name}} syntax
  displayName           String?   @map("display_name") @db.VarChar(200)  // Human-readable name shown in UI
  description           String?   @db.Text
  content               String    @db.Text
  placeholders          Json      @default("[]")

  createdById           String    @map("created_by_id")
  createdBy             User      @relation("PartialCreator", fields: [createdById], references: [id])
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("template_partials")
}

// AI Conversations - Chat history for AI assistant
model AiConversation {
  id                    String   @id @default(uuid())
  tenantId              String   @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id])
  userId                String   @map("user_id")
  user                  User     @relation("ConversationOwner", fields: [userId], references: [id])

  contextType           String   @db.VarChar(20) // 'template' or 'document'
  contextId             String?  @map("context_id") // Template or Document ID
  messages              Json     @default("[]") // Array of {role, content, timestamp}

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([tenantId, userId])
  @@index([contextType, contextId])
  @@map("ai_conversations")
}
